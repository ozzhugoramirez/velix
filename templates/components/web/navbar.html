{% load socialaccount %}
{% load static %}

<style>
    :root {
        --emerald: rgb(25, 90, 89);
        --gold: rgb(200, 160, 90);
        --bg-dark: rgb(23, 23, 23);
        --bg-panel: rgba(23, 23, 23, 0.95);
        --border-color: rgba(255, 255, 255, 0.1);
        --text-white: rgba(255, 255, 255, 0.9);
        --text-muted: rgba(255, 255, 255, 0.6);
        --danger: #ef4444; /* Agregado para notificaciones */
    }

    /* Base Setup */
    body.dark {
        background-color: #0a0a0a;
        color: white;
    }

    /* Navbar Container - RESTAURADO A 64PX */
    .glass-header {
        position: sticky;
        top: 0;
        z-index: 1050;
        width: 100%;
        background-color: rgba(23, 23, 23, 0.8);
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        border-bottom: 1px solid var(--border-color);
        height: 64px; /* Altura original */
        display: flex;
        align-items: center;
    }

    .nav-container {
        max-width: 1280px;
        margin: 0 auto;
        padding: 0 1rem;
        width: 100%;
        display: flex;
        align-items: center;
        justify-content: space-between;
        position: relative;
    }

    /* Logo Central - ORIGINAL */
    .logo-center {
        position: absolute;
        left: 50%;
        top: 50%;
        transform: translate(-50%, -50%);
        display: flex;
        z-index: 10;
    }
    .logo-ring {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        display: grid;
        place-items: center;
        background: linear-gradient(90deg, var(--gold) 50%, var(--emerald) 50%);
        box-shadow: 0 0 0 1px rgba(255,255,255,0.1);
    }

    /* Botones/Links (Pills) - ORIGINAL */
    .nav-pill {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.375rem 0.75rem;
        font-size: 0.875rem;
        color: var(--text-white);
        border-radius: 9999px;
        border: 1px solid var(--border-color);
        background: transparent;
        text-decoration: none;
        transition: all 0.2s;
        cursor: pointer;
        position: relative; /* Para posicionar badges */
    }
    .nav-pill:hover {
        background: rgba(255,255,255,0.05);
        border-color: rgba(255,255,255,0.2);
    }
    /* Clase extra para botones que son solo icono (cuadrados redondeados) */
    .nav-pill-icon {
        padding: 0.4rem;
        color: var(--text-muted);
    }
    .nav-pill-icon:hover { color: white; }

    /* Buscador Complex - ORIGINAL REDONDEADO */
    .search-wrapper {
        position: relative;
        margin-left: 0.5rem;
        display: none;
        width: 280px;
        align-items: center;
    }
    @media(min-width: 640px) { .search-wrapper { display: flex; } }
    @media(min-width: 768px) { .search-wrapper { width: 360px; } }

    .search-input-container {
        position: relative;
        width: 100%;
    }

    .ghost-text {
        position: absolute;
        inset: 0;
        padding-left: 2.5rem;
        padding-right: 2.5rem;
        display: flex;
        align-items: center;
        font-size: 0.875rem;
        color: rgba(255, 255, 255, 0.35);
        pointer-events: none;
        white-space: pre;
    }

    .search-input {
        width: 100%;
        background-color: rgba(38, 38, 38, 0.8);
        border: 1px solid var(--gold); /* Borde dorado original */
        border-radius: 9999px; /* REDONDEADO ORIGINAL */
        padding: 0.5rem 2.5rem 0.5rem 2.5rem;
        color: white;
        font-size: 0.875rem;
        outline: none;
        transition: box-shadow 0.2s;
        position: relative; 
        z-index: 2;
        background: transparent;
    }
    .search-input:focus {
        box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.1);
    }
    
    .search-icon-left {
        position: absolute;
        left: 0.75rem;
        top: 50%;
        transform: translateY(-50%);
        color: rgba(255,255,255,0.7);
        z-index: 3;
    }

    /* Panel de Resultados */
    .search-panel {
        position: absolute;
        top: calc(100% + 8px);
        left: 0;
        width: min(92vw, 720px);
        background-color: var(--bg-panel);
        backdrop-filter: blur(16px);
        -webkit-backdrop-filter: blur(16px);
        border: 1px solid var(--border-color);
        border-radius: 1rem;
        padding: 0.75rem;
        display: grid;
        grid-template-columns: 1fr;
        gap: 1rem;
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        visibility: hidden;
        opacity: 0;
        transform: translateY(-10px);
        transition: all 0.2s ease;
        z-index: 1060;
    }
    @media(min-width: 768px) { .search-panel { grid-template-columns: 1fr 1fr; } }
    .search-panel.open { visibility: visible; opacity: 1; transform: translateY(0); }

    .panel-section-title {
        font-size: 0.75rem; text-transform: uppercase; color: var(--text-muted);
        margin-bottom: 0.5rem; padding-left: 0.5rem;
    }

    .suggestion-item {
        display: flex; justify-content: space-between; align-items: center; width: 100%;
        padding: 0.5rem 0.75rem; border-radius: 0.5rem; color: var(--text-white);
        font-size: 0.875rem; cursor: pointer; background: transparent; border: none; text-align: left;
    }
    .suggestion-item:hover { background: rgba(255,255,255,0.05); }

    .offer-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; }
    .offer-card {
        border-radius: 0.75rem; overflow: hidden; border: 1px solid var(--border-color);
        text-decoration: none; color: white; transition: all 0.2s;
    }
    .offer-card:hover { border-color: rgba(255,255,255,0.2); }
    .offer-img { aspect-ratio: 4/3; width: 100%; background: #222; object-fit: cover; }
    .offer-info { padding: 0.5rem; }
    .offer-title { font-size: 0.75rem; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .offer-price { font-size: 0.7rem; color: var(--text-muted); margin-top: 2px; }

    /* Menus Dropdown (Idioma) */
    .dropdown-menu-custom {
        display: none; position: absolute; right: 0; top: 100%; margin-top: 0.5rem; width: 10rem;
        background-color: var(--bg-panel); border: 1px solid var(--border-color);
        border-radius: 0.75rem; padding: 0.25rem; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        z-index: 1100;
    }
    .dropdown-menu-custom.show { display: block; }
    
    .lang-option {
        width: 100%; display: flex; align-items: center; justify-content: space-between;
        padding: 0.5rem 0.75rem; color: var(--text-white); font-size: 0.875rem;
        background: none; border: none; border-radius: 0.5rem; cursor: pointer;
    }
    .lang-option:hover { background: rgba(255,255,255,0.05); }

    /* Auth Right Side */
    .auth-section { margin-left: auto; display: flex; align-items: center; gap: 0.5rem; }
    
    /* AVATAR ORIGINAL */
    .user-avatar {
        width: 36px; height: 36px; border-radius: 0.75rem; overflow: hidden;
        border: 1px solid var(--border-color); transition: transform 0.2s, box-shadow 0.2s;
    }
    .user-avatar:hover {
        transform: scale(1.03); box-shadow: 0 0 0 2px rgba(200, 160, 90, 0.7);
    }

    /* NUEVO: Badges para notificaciones/carrito */
    .badge-dot {
        position: absolute; top: -2px; right: -2px;
        min-width: 16px; height: 16px; border-radius: 50%;
        font-size: 9px; font-weight: 800; display: flex; align-items: center; justify-content: center;
        box-shadow: 0 2px 5px rgba(0,0,0,0.5);
    }
    .bg-red { background: var(--danger); color: white; }
    .bg-gold { background: var(--gold); color: rgb(25,90,89); }

    .hidden { display: none !important; }
</style>

<header class="glass-header">
    <div class="nav-container">
        
        <div style="display: flex; align-items: center; gap: 0.5rem;">
            <a href="{% url 'home' %}" class="nav-pill">
                
                <span style="display:none;" class="d-sm-inline">Home</span>
            </a>
            
            <a href="{% url 'shop' %}" class="nav-pill">Shops</a>

            <div class="search-wrapper" id="searchWrapper">
                <form action="{% url 'Search' %}" method="GET" id="searchForm" style="width: 100%; position: relative;">
                    
                    <div class="search-input-container">
                        <span class="search-icon-left">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0 0 16 9.5 6.5 6.5 0 1 0 9.5 16a6.471 6.471 0 0 0 4.23-1.57l.27.28h.79L20 19.5 21.5 18 15.5 14zM9.5 14A4.5 4.5 0 1 1 14 9.5 4.505 4.505 0 0 1 9.5 14z"/></svg>
                        </span>

                        <div class="ghost-text">
                            <span style="opacity: 0" id="ghostHiddenPart"></span><span id="ghostVisiblePart"></span>
                        </div>

                        <input 
                            type="text" 
                            name="q" 
                            id="searchInput" 
                            class="search-input" 
                            placeholder="Search Games..." 
                            autocomplete="off"
                        >

                        <button type="button" style="position: absolute; right: 6px; top: 50%; transform: translateY(-50%); background:none; border:none; color: rgba(255,255,255,0.8); cursor: pointer;" class="nav-pill" style="padding: 4px;">
                            <svg viewBox="0 0 24 24" width="14" height="14" fill="currentColor"><path d="M6 10h12v2H6v-2zm-3 6h18v2H3v-2zM3 6h18v2H3V6z"/></svg>
                        </button>
                    </div>

                    <div id="searchPanel" class="search-panel">
                        <div style="padding-right: 0.5rem;">
                            <div class="panel-section-title">Sugerencias</div>
                            <div id="suggestionsList">
                                <div style="padding: 0.5rem; color: var(--text-muted); font-size: 0.8rem;">Escribe para buscar...</div>
                            </div>
                        </div>
                        <div style="border-left: 1px solid var(--border-color); padding-left: 0.5rem;">
                            <div class="panel-section-title">Ofertas Relacionadas</div>
                            <div id="offersGrid" class="offer-grid"></div>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <a href="{% url 'home' %}" class="logo-center">
            <span class="logo-ring">
                <svg width="36" height="36" viewBox="0 0 36 36" aria-hidden>
                  <circle cx="18" cy="18" r="17" fill="transparent" stroke="rgba(255,255,255,.18)" />
                  <circle cx="12" cy="12" r="2" fill="white" />
                </svg>
            </span>
        </a>

        <div class="auth-section">
            
            <div style="position: relative;">
                <button id="langToggle" class="nav-pill nav-pill-icon">
                    <span style="text-transform: uppercase; font-weight:bold; font-size: 0.75rem;">ES</span>
                    <svg width="10" height="10" viewBox="0 0 24 24" fill="currentColor"><path d="M7 10l5 5 5-5z"/></svg>
                </button>
                <div id="langMenu" class="dropdown-menu-custom">
                    <button class="lang-option" data-lang="es"><span>Español</span></button>
                    <button class="lang-option" data-lang="en"><span>English</span></button>
                    <button class="lang-option" data-lang="zh"><span>中文</span></button>
                </div>
            </div>

            <button id="themeToggle" class="nav-pill nav-pill-icon">
                <svg id="iconSun" class="hidden" width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M6.76 4.84l-1.8-1.79-1.41 1.41 1.79 1.8 1.42-1.42zM1 13h3v-2H1v2zm10 10h2v-3h-2v3zm9-10v-2h-3v2h3zm-3.95 7.95l1.41 1.41 1.8-1.79-1.41-1.41-1.8 1.79zM11 1h2v3h-2V1zm-4.24 16.24l-1.79 1.8 1.41 1.41 1.8-1.79-1.42-1.42zM17 12a5 5 0 1 1-10 0 5 5 0 0 1 10 0z"/></svg>
                <svg id="iconMoon" width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M21 12.79A9 9 0 1 1 11.21 3a7 7 0 1 0 9.79 9.79z"/></svg>
            </button>

            {% if user.is_authenticated %}
                
                <a href="{% url 'notification_list' %}" class="nav-pill nav-pill-icon" title="Notificaciones">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path><path d="M13.73 21a2 2 0 0 1-3.46 0"></path></svg>
                    {% if unread_notifications_count > 0 %}
                        <span class="badge-dot bg-red">{{ unread_notifications_count }}</span>
                    {% endif %}
                </a>

                <a href="{% url 'cart' %}" class="nav-pill nav-pill-icon" title="Carrito">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="9" cy="21" r="1"></circle><circle cx="20" cy="21" r="1"></circle><path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path></svg>
                    {% if cart_item_count > 0 %}
                        <span class="badge-dot bg-gold">{{ cart_item_count }}</span>
                    {% endif %}
                </a>

                <a href="{% url 'profile' %}" class="user-avatar" title="{{ user.username }}">
                    {% if user.avatar %}
                        <img src="{{ user.avatar.url }}" alt="Profile" style="width:100%; height:100%; object-fit:cover;">
                    {% else %}
                        <img src="https://i.pravatar.cc/150?u={{ user.username }}" alt="Profile" style="width:100%; height:100%; object-fit:cover;">
                    {% endif %}
                </a>
            {% else %}
                <a href="{% provider_login_url 'google' %}" class="nav-pill" style="font-weight: 500;">Ingresar</a>
            {% endif %}
        </div>
    </div>
</header>

<script>
document.addEventListener('DOMContentLoaded', function() {
    
    // --- BÚSQUEDA ---
    const API_URL = '/api/productos/'; 
    const SUFFIXES = {
        "olla": ["de acero", "de presión", "de barro"],
        "sartén": ["antiadherente", "de hierro", "wok"],
        "cuchillo": ["de chef", "santoku", "parrillero"],
        "juego": ["de mesa", "de rol", "de pc"]
    };

    const searchInput = document.getElementById('searchInput');
    const searchPanel = document.getElementById('searchPanel');
    const ghostHidden = document.getElementById('ghostHiddenPart');
    const ghostVisible = document.getElementById('ghostVisiblePart');
    const suggestionsList = document.getElementById('suggestionsList');
    const offersGrid = document.getElementById('offersGrid');
    const searchForm = document.getElementById('searchForm');
    
    let debounceTimer;
    let currentSuggestion = "";

    searchInput.addEventListener('input', function(e) {
        const val = e.target.value;
        handleGhostText(val);
        if(val.length > 0) {
            searchPanel.classList.add('open');
        } else {
            searchPanel.classList.remove('open');
            return;
        }
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(() => {
            fetchSuggestions(val);
            fetchOffers(val);
        }, 300);
    });

    searchInput.addEventListener('keydown', function(e) {
        if(e.key === 'Tab' && currentSuggestion) {
            e.preventDefault();
            searchInput.value = currentSuggestion;
            handleGhostText(currentSuggestion);
        }
    });

    document.addEventListener('click', function(e) {
        if (!document.getElementById('searchWrapper').contains(e.target)) {
            searchPanel.classList.remove('open');
        }
    });

    function handleGhostText(val) {
        ghostHidden.textContent = val; 
        ghostVisible.textContent = "";
        currentSuggestion = "";
        if(!val) return;
        const lowerVal = val.toLowerCase();
        for (const [key, suffixes] of Object.entries(SUFFIXES)) {
            if (lowerVal.includes(key)) {
                const match = suffixes.find(s => (key + " " + s).startsWith(lowerVal) && (key + " " + s) !== lowerVal);
                if (match) {
                    const fullText = key + " " + match;
                    if(fullText.startsWith(lowerVal)) {
                        ghostVisible.textContent = fullText.substring(lowerVal.length);
                        currentSuggestion = fullText;
                    }
                }
            }
        }
    }

    function fetchOffers(query) {
        const demoData = [
            { title: query + " Edición Coleccionista", price: "USD 120.00", img: null },
            { title: query + " Standard", price: "USD 59.99", img: null },
        ];
        renderOffers(demoData);
    }
    
    function fetchSuggestions(query) {
        const html = `
            <button class="suggestion-item" type="button" onclick="selectSuggestion('${query}')">
                <span>Buscar: <b>${query}</b></span>
            </button>
        `;
        suggestionsList.innerHTML = html;
    }

    function renderOffers(products) {
        if(products.length === 0) {
            offersGrid.innerHTML = '<div style="grid-column: span 2; padding:1rem; opacity:0.6">Sin resultados</div>';
            return;
        }
        const html = products.map((p, idx) => {
            const grad = idx % 2 === 0 ? 'linear-gradient(135deg, #1f2937, #111827)' : 'linear-gradient(135deg, rgb(200,160,90), rgb(25,90,89))';
            const imgStyle = p.img ? `background-image: url('${p.img}')` : `background: ${grad}`;
            return `
            <a href="/search?q=${p.title}" class="offer-card">
                <div class="offer-img" style="${imgStyle}"></div>
                <div class="offer-info">
                    <div class="offer-title">${p.title}</div>
                    <div class="offer-price">${p.price}</div>
                </div>
            </a>
            `;
        }).join('');
        offersGrid.innerHTML = html;
    }

    window.selectSuggestion = function(text) {
        searchInput.value = text;
        searchForm.submit();
    };


    // --- IDIOMA & TEMA ---
    const langToggle = document.getElementById('langToggle');
    const langMenu = document.getElementById('langMenu');
    
    langToggle.addEventListener('click', (e) => {
        e.stopPropagation();
        langMenu.classList.toggle('show');
    });

    document.querySelectorAll('.lang-option').forEach(btn => {
        btn.addEventListener('click', () => {
            const lang = btn.dataset.lang;
            // Lógica cookie Django
            alert('Idioma: ' + lang); 
            location.reload();
        });
    });

    document.addEventListener('click', (e) => {
        if (!langToggle.contains(e.target)) langMenu.classList.remove('show');
    });

    const themeToggle = document.getElementById('themeToggle');
    const iconSun = document.getElementById('iconSun');
    const iconMoon = document.getElementById('iconMoon');
    
    const isDark = localStorage.getItem('theme') !== 'light';
    applyTheme(isDark);

    themeToggle.addEventListener('click', () => {
        const currentDark = document.body.classList.contains('dark');
        applyTheme(!currentDark);
    });

    function applyTheme(dark) {
        if(dark) {
            document.body.classList.add('dark');
            iconSun.classList.add('hidden');
            iconMoon.classList.remove('hidden');
            localStorage.setItem('theme', 'dark');
        } else {
            document.body.classList.remove('dark');
            iconSun.classList.remove('hidden');
            iconMoon.classList.add('hidden');
            localStorage.setItem('theme', 'light');
        }
    }
});
</script>