{% load socialaccount %}


<style>
    :root {
        --emerald: rgb(25, 90, 89);
        --gold: rgb(200, 160, 90);
        --bg-dark: rgb(23, 23, 23);
        --bg-panel: rgba(23, 23, 23, 0.95);
        --border-color: rgba(255, 255, 255, 0.1);
        --text-white: rgba(255, 255, 255, 0.9);
        --text-muted: rgba(255, 255, 255, 0.6);
    }

    /* Base Setup */
    body.dark {
        background-color: #0a0a0a;
        color: white;
    }

    /* Navbar Container */
    .glass-header {
        position: sticky;
        top: 0;
        z-index: 1050;
        width: 100%;
        background-color: rgba(23, 23, 23, 0.8);
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        border-bottom: 1px solid var(--border-color);
        height: 64px;
        display: flex;
        align-items: center;
    }

    .nav-container {
        max-width: 1280px;
        margin: 0 auto;
        padding: 0 1rem;
        width: 100%;
        display: flex;
        align-items: center;
        justify-content: space-between;
        position: relative;
    }

    /* Logo Central */
    .logo-center {
        position: absolute;
        left: 50%;
        top: 50%;
        transform: translate(-50%, -50%);
        display: flex;
    }
    .logo-ring {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        display: grid;
        place-items: center;
        background: linear-gradient(90deg, var(--gold) 50%, var(--emerald) 50%);
        box-shadow: 0 0 0 1px rgba(255,255,255,0.1);
    }

    /* Botones/Links (Pills) */
    .nav-pill {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.375rem 0.75rem;
        font-size: 0.875rem;
        color: var(--text-white);
        border-radius: 9999px;
        border: 1px solid var(--border-color);
        background: transparent;
        text-decoration: none;
        transition: all 0.2s;
        cursor: pointer;
    }
    .nav-pill:hover {
        background: rgba(255,255,255,0.05);
        border-color: rgba(255,255,255,0.2);
    }

    /* Buscador Complex */
    .search-wrapper {
        position: relative;
        margin-left: 0.5rem;
        display: none;
        width: 280px;
        align-items: center;
    }
    @media(min-width: 640px) { .search-wrapper { display: flex; } }
    @media(min-width: 768px) { .search-wrapper { width: 360px; } }

    .search-input-container {
        position: relative;
        width: 100%;
    }

    /* Ghost text (Sugerencia fantasma) */
    .ghost-text {
        position: absolute;
        inset: 0;
        padding-left: 2.5rem; /* Espacio del icono */
        padding-right: 2.5rem;
        display: flex;
        align-items: center;
        font-size: 0.875rem;
        color: rgba(255, 255, 255, 0.35);
        pointer-events: none;
        white-space: pre;
    }

    .search-input {
        width: 100%;
        background-color: rgba(38, 38, 38, 0.8);
        border: 1px solid var(--gold); /* Borde dorado como en el diseño */
        border-radius: 9999px;
        padding: 0.5rem 2.5rem 0.5rem 2.5rem;
        color: white;
        font-size: 0.875rem;
        outline: none;
        transition: box-shadow 0.2s;
        /* Hacemos el fondo transparente si es necesario ver algo detrás, pero aquí usamos solido */
        position: relative; 
        z-index: 2;
        background: transparent; /* Para ver el ghost text */
    }
    .search-input:focus {
        box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.1);
    }
    
    .search-icon-left {
        position: absolute;
        left: 0.75rem;
        top: 50%;
        transform: translateY(-50%);
        color: rgba(255,255,255,0.7);
        z-index: 3;
    }

    /* Panel de Resultados (Dropdown) */
    .search-panel {
        position: absolute;
        top: calc(100% + 8px);
        left: 0;
        width: min(92vw, 720px);
        background-color: var(--bg-panel);
        backdrop-filter: blur(16px);
        -webkit-backdrop-filter: blur(16px);
        border: 1px solid var(--border-color);
        border-radius: 1rem;
        padding: 0.75rem;
        display: grid;
        grid-template-columns: 1fr;
        gap: 1rem;
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        visibility: hidden;
        opacity: 0;
        transform: translateY(-10px);
        transition: all 0.2s ease;
        z-index: 1060;
    }
    @media(min-width: 768px) { .search-panel { grid-template-columns: 1fr 1fr; } }

    .search-panel.open {
        visibility: visible;
        opacity: 1;
        transform: translateY(0);
    }

    .panel-section-title {
        font-size: 0.75rem;
        text-transform: uppercase;
        color: var(--text-muted);
        margin-bottom: 0.5rem;
        padding-left: 0.5rem;
    }

    .suggestion-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        width: 100%;
        padding: 0.5rem 0.75rem;
        border-radius: 0.5rem;
        color: var(--text-white);
        font-size: 0.875rem;
        cursor: pointer;
        background: transparent;
        border: none;
        text-align: left;
    }
    .suggestion-item:hover { background: rgba(255,255,255,0.05); }

    /* Cards de productos en el buscador */
    .offer-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 0.5rem;
    }
    .offer-card {
        border-radius: 0.75rem;
        overflow: hidden;
        border: 1px solid var(--border-color);
        text-decoration: none;
        color: white;
        transition: all 0.2s;
    }
    .offer-card:hover { border-color: rgba(255,255,255,0.2); }
    .offer-img {
        aspect-ratio: 4/3;
        width: 100%;
        background: #222;
        object-fit: cover;
    }
    .offer-info { padding: 0.5rem; }
    .offer-title { font-size: 0.75rem; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .offer-price { font-size: 0.7rem; color: var(--text-muted); margin-top: 2px; }

    /* Menus Dropdown (Idioma) */
    .dropdown-menu-custom {
        display: none;
        position: absolute;
        right: 0;
        top: 100%;
        margin-top: 0.5rem;
        width: 10rem;
        background-color: var(--bg-panel);
        border: 1px solid var(--border-color);
        border-radius: 0.75rem;
        padding: 0.25rem;
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
    }
    .dropdown-menu-custom.show { display: block; }
    
    .lang-option {
        width: 100%;
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0.5rem 0.75rem;
        color: var(--text-white);
        font-size: 0.875rem;
        background: none;
        border: none;
        border-radius: 0.5rem;
        cursor: pointer;
    }
    .lang-option:hover { background: rgba(255,255,255,0.05); }
    .lang-option.active { outline: 1px solid var(--gold); }
    .lang-dot { width: 6px; height: 6px; background-color: var(--gold); border-radius: 50%; }

    /* Auth Right Side */
    .auth-section { margin-left: auto; display: flex; align-items: center; gap: 0.5rem; }
    
    .balance-pill {
        display: none;
        align-items: center;
        gap: 0.5rem;
        padding: 0.25rem 0.75rem;
        border-radius: 9999px;
        background: rgba(255,255,255,0.06);
        border: 1px solid var(--border-color);
        font-size: 0.75rem;
        color: var(--text-white);
    }
    @media(min-width: 640px) { .balance-pill { display: flex; } }
    
    .coin-icon {
        width: 1rem; height: 1rem;
        border-radius: 50%;
        background-color: var(--gold);
        color: var(--emerald);
        display: flex; align-items: center; justify-content: center;
    }

    .user-avatar {
        width: 36px; height: 36px;
        border-radius: 0.75rem;
        overflow: hidden;
        border: 1px solid var(--border-color);
        transition: transform 0.2s, box-shadow 0.2s;
    }
    .user-avatar:hover {
        transform: scale(1.03);
        box-shadow: 0 0 0 2px rgba(200, 160, 90, 0.7);
    }

    /* Utilitarios */
    .hidden { display: none !important; }
</style>

<header class="glass-header">
    <div class="nav-container">
        
        <div style="display: flex; align-items: center; gap: 0.5rem;">
            <a href="{% url 'home' %}" class="nav-pill">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" style="opacity:0.9"><path d="M6 7a5 5 0 0 0-5 5v2a4 4 0 0 0 4 4h2l2-2h6l2 2h2a4 4 0 0 0 4-4v-2a5 5 0 0 0-5-5H6zM8 12H7v-1a1 1 0 1 0-2 0v1H4a1 1 0 1 0 0 2h1v1a1 1 0 1 0 2 0v-1h1a1 1 0 1 0 0-2z"/></svg>
                <span style="display:none;" class="d-sm-inline">Home</span>
            </a>
            
            <a href="{% url 'shop' %}" class="nav-pill">Shops</a>

            <div class="search-wrapper" id="searchWrapper">
                <form action="{% url 'Search' %}" method="GET" id="searchForm" style="width: 100%; position: relative;">
                    
                    <div class="search-input-container">
                        <span class="search-icon-left">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0 0 16 9.5 6.5 6.5 0 1 0 9.5 16a6.471 6.471 0 0 0 4.23-1.57l.27.28h.79L20 19.5 21.5 18 15.5 14zM9.5 14A4.5 4.5 0 1 1 14 9.5 4.505 4.505 0 0 1 9.5 14z"/></svg>
                        </span>

                        <div class="ghost-text">
                            <span style="opacity: 0" id="ghostHiddenPart"></span><span id="ghostVisiblePart"></span>
                        </div>

                        <input 
                            type="text" 
                            name="q" 
                            id="searchInput" 
                            class="search-input" 
                            placeholder="Search Games..." 
                            autocomplete="off"
                        >

                        <button type="button" style="position: absolute; right: 6px; top: 50%; transform: translateY(-50%); background:none; border:none; color: rgba(255,255,255,0.8); cursor: pointer;" class="nav-pill" style="padding: 4px;">
                            <svg viewBox="0 0 24 24" width="14" height="14" fill="currentColor"><path d="M6 10h12v2H6v-2zm-3 6h18v2H3v-2zM3 6h18v2H3V6z"/></svg>
                        </button>
                    </div>

                    <div id="searchPanel" class="search-panel">
                        
                        <div style="padding-right: 0.5rem;">
                            <div class="panel-section-title">Sugerencias</div>
                            <div id="suggestionsList">
                                <div style="padding: 0.5rem; color: var(--text-muted); font-size: 0.8rem;">Escribe para buscar...</div>
                            </div>
                        </div>

                        <div style="border-left: 1px solid var(--border-color); padding-left: 0.5rem;">
                            <div class="panel-section-title">Ofertas Relacionadas</div>
                            <div id="offersGrid" class="offer-grid">
                                </div>
                        </div>

                    </div>
                </form>
            </div>
        </div>

        <a href="{% url 'home' %}" class="logo-center">
            <span class="logo-ring">
                <svg width="36" height="36" viewBox="0 0 36 36" aria-hidden>
                  <circle cx="18" cy="18" r="17" fill="transparent" stroke="rgba(255,255,255,.18)" />
                  <circle cx="12" cy="12" r="2" fill="white" />
                </svg>
            </span>
        </a>

        <div class="auth-section">
            
            <div style="position: relative;">
                <button id="langToggle" class="nav-pill">
                    <span style="text-transform: uppercase;" id="currentLangLabel">ES</span>
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor"><path d="M7 10l5 5 5-5z"/></svg>
                </button>
                <div id="langMenu" class="dropdown-menu-custom">
                    <button class="lang-option" data-lang="es"><span>Español</span><span class="lang-dot"></span></button>
                    <button class="lang-option" data-lang="en"><span>English</span></button>
                    <button class="lang-option" data-lang="zh"><span>中文</span></button>
                </div>
            </div>

            <button id="themeToggle" class="nav-pill" style="padding: 0.5rem;">
                <svg id="iconSun" class="hidden" width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M6.76 4.84l-1.8-1.79-1.41 1.41 1.79 1.8 1.42-1.42zM1 13h3v-2H1v2zm10 10h2v-3h-2v3zm9-10v-2h-3v2h3zm-3.95 7.95l1.41 1.41 1.8-1.79-1.41-1.41-1.8 1.79zM11 1h2v3h-2V1zm-4.24 16.24l-1.79 1.8 1.41 1.41 1.8-1.79-1.42-1.42zM17 12a5 5 0 1 1-10 0 5 5 0 0 1 10 0z"/></svg>
                <svg id="iconMoon" width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M21 12.79A9 9 0 1 1 11.21 3a7 7 0 1 0 9.79 9.79z"/></svg>
            </button>

            {% if user.is_authenticated %}
                <a href="{% url 'cart' %}" class="nav-pill" style="padding: 0.5rem; position: relative;">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M7 18a2 2 0 1 0 0 4 2 2 0 0 0 0-4zm10 0a2 2 0 1 0 0 4 2 2 0 0 0 0-4zM6.42 6H21l-1 8H8.42L4 4H2V2h3l1.4 3.5L6.42 6z"/></svg>
                    {% if cart_item_count > 0 %}
                    <span style="position: absolute; top: -4px; right: -4px; background: var(--gold); color: rgb(25,90,89); font-size: 10px; font-weight: bold; border-radius: 50%; height: 16px; width: 16px; display: flex; align-items: center; justify-content: center;">
                        {{ cart_item_count }}
                    </span>
                    {% endif %}
                </a>

                <div class="balance-pill">
                    <span class="coin-icon">
                        <svg width="10" height="10" viewBox="0 0 24 24" fill="currentColor"><circle cx="12" cy="12" r="10"/></svg>
                    </span>
                    <span>{{ user.balance|default:"130 000 000" }}</span> 
                </div>

                <a href="{% url 'profile' %}" class="user-avatar" title="{{ user.username }}">
                    {% if user.avatar %}
                        <img src="{{ user.avatar.url }}" alt="Profile" style="width:100%; height:100%; object-fit:cover;">
                    {% else %}
                        <img src="https://i.pravatar.cc/150?u={{ user.username }}" alt="Profile" style="width:100%; height:100%; object-fit:cover;">
                    {% endif %}
                </a>
            {% else %}
                <a href="{% provider_login_url 'google' %}" class="nav-pill" style="font-weight: 500;">Ingresar</a>
            {% endif %}
        </div>
    </div>
</header>







<script>
document.addEventListener('DOMContentLoaded', function() {
    
    // --- CONFIGURACIÓN ---
    const API_URL = '/api/productos/'; // Tu endpoint de Django REST Framework
    const SUFFIXES = {
        "olla": ["de acero", "de presión", "de barro"],
        "sartén": ["antiadherente", "de hierro", "wok"],
        "cuchillo": ["de chef", "santoku", "parrillero"],
        "juego": ["de mesa", "de rol", "de pc"]
    };

    // --- REFERENCIAS DOM ---
    const searchInput = document.getElementById('searchInput');
    const searchPanel = document.getElementById('searchPanel');
    const ghostHidden = document.getElementById('ghostHiddenPart');
    const ghostVisible = document.getElementById('ghostVisiblePart');
    const suggestionsList = document.getElementById('suggestionsList');
    const offersGrid = document.getElementById('offersGrid');
    const searchForm = document.getElementById('searchForm');
    
    let debounceTimer;
    let currentSuggestion = "";

    // --- LÓGICA DE BÚSQUEDA ---
    searchInput.addEventListener('input', function(e) {
        const val = e.target.value;
        
        // 1. Manejo del Ghost Text (Autocompletado visual)
        handleGhostText(val);

        // 2. Mostrar/Ocultar Panel
        if(val.length > 0) {
            searchPanel.classList.add('open');
        } else {
            searchPanel.classList.remove('open');
            return;
        }

        // 3. Fetch de datos (Debounce 300ms)
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(() => {
            fetchSuggestions(val);
            fetchOffers(val);
        }, 300);
    });

    // Aceptar sugerencia con TAB
    searchInput.addEventListener('keydown', function(e) {
        if(e.key === 'Tab' && currentSuggestion) {
            e.preventDefault();
            searchInput.value = currentSuggestion;
            handleGhostText(currentSuggestion);
        }
    });

    // Click fuera para cerrar
    document.addEventListener('click', function(e) {
        if (!document.getElementById('searchWrapper').contains(e.target)) {
            searchPanel.classList.remove('open');
        }
    });

    function handleGhostText(val) {
        ghostHidden.textContent = val; // Texto invisible para empujar el visible
        ghostVisible.textContent = "";
        currentSuggestion = "";

        if(!val) return;

        // Buscar coincidencia simple local
        const lowerVal = val.toLowerCase();
        for (const [key, suffixes] of Object.entries(SUFFIXES)) {
            if (lowerVal.includes(key)) {
                const match = suffixes.find(s => (key + " " + s).startsWith(lowerVal) && (key + " " + s) !== lowerVal);
                if (match) {
                    const fullText = key + " " + match;
                    // Solo mostramos lo que falta por escribir
                    if(fullText.startsWith(lowerVal)) {
                        ghostVisible.textContent = fullText.substring(lowerVal.length);
                        currentSuggestion = fullText;
                    }
                }
            }
        }
    }

    // --- FETCH A DJANGO API ---
    // Simulación si no tienes la API lista, borra esto y usa el fetch real abajo
    function fetchOffers(query) {
        // Aquí deberías hacer: fetch(`${API_URL}?search=${query}&page_size=4`)
        // Simulamos respuesta para que veas el diseño:
        
        // ESTO ES SOLO DEMO, REEMPLAZAR CON TU FETCH REAL
        const demoData = [
            { title: query + " Edición Coleccionista", price: "USD 120.00", img: null },
            { title: query + " Standard", price: "USD 59.99", img: null },
            { title: "Accesorio para " + query, price: "USD 15.50", img: null },
            { title: "Guía de " + query, price: "USD 9.99", img: null },
        ];
        
        renderOffers(demoData);
    }
    
    function fetchSuggestions(query) {
        // Lógica simple de sugerencias locales + query
        const html = `
            <button class="suggestion-item" type="button" onclick="selectSuggestion('${query}')">
                <span>Buscar: <b>${query}</b></span>
                <span style="opacity:0.5">↵</span>
            </button>
            <button class="suggestion-item" type="button" onclick="selectSuggestion('${query} barato')">
                <span>${query} barato</span>
            </button>
             <button class="suggestion-item" type="button" onclick="selectSuggestion('${query} nuevo')">
                <span>${query} nuevo</span>
            </button>
        `;
        suggestionsList.innerHTML = html;
    }

    function renderOffers(products) {
        if(products.length === 0) {
            offersGrid.innerHTML = '<div style="grid-column: span 2; padding:1rem; opacity:0.6">Sin resultados</div>';
            return;
        }

        const html = products.map((p, idx) => {
            // Gradiente aleatorio para demo si no hay imagen
            const grad = idx % 2 === 0 ? 'linear-gradient(135deg, #1f2937, #111827)' : 'linear-gradient(135deg, rgb(200,160,90), rgb(25,90,89))';
            const imgStyle = p.img ? `background-image: url('${p.img}')` : `background: ${grad}`;
            
            return `
            <a href="/search?q=${p.title}" class="offer-card">
                <div class="offer-img" style="${imgStyle}"></div>
                <div class="offer-info">
                    <div class="offer-title">${p.title}</div>
                    <div class="offer-price">${p.price}</div>
                </div>
            </a>
            `;
        }).join('');
        offersGrid.innerHTML = html;
    }

    // Función global para click en sugerencia
    window.selectSuggestion = function(text) {
        searchInput.value = text;
        searchForm.submit();
    };


    // --- IDIOMA Y TEMA ---
    const langToggle = document.getElementById('langToggle');
    const langMenu = document.getElementById('langMenu');
    
    langToggle.addEventListener('click', (e) => {
        e.stopPropagation();
        langMenu.classList.toggle('show');
    });

    document.querySelectorAll('.lang-option').forEach(btn => {
        btn.addEventListener('click', () => {
            const lang = btn.dataset.lang;
            document.cookie = `django_language=${lang}; path=/`; // Cookie estándar de Django
            location.reload();
        });
    });

    // Cerrar menú al hacer click fuera
    document.addEventListener('click', (e) => {
        if (!langToggle.contains(e.target)) langMenu.classList.remove('show');
    });

    // Tema (Dark/Light)
    const themeToggle = document.getElementById('themeToggle');
    const iconSun = document.getElementById('iconSun');
    const iconMoon = document.getElementById('iconMoon');
    
    // Cargar tema guardado
    const isDark = localStorage.getItem('theme') !== 'light'; // Default Dark
    applyTheme(isDark);

    themeToggle.addEventListener('click', () => {
        const currentDark = document.body.classList.contains('dark');
        applyTheme(!currentDark);
    });

    function applyTheme(dark) {
        if(dark) {
            document.body.classList.add('dark');
            iconSun.classList.add('hidden');
            iconMoon.classList.remove('hidden');
            localStorage.setItem('theme', 'dark');
        } else {
            document.body.classList.remove('dark');
            iconSun.classList.remove('hidden');
            iconMoon.classList.add('hidden');
            localStorage.setItem('theme', 'light');
        }
    }
});
</script>