{% load static %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="{% static 'bootstrap/css/bootstrap.min.css' %}">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="icon" type="image/png" href="{% static 'icon/logo.jpg' %}">

    <title></title>
    <style>
            /* Estilo general para navegadores WebKit (Chrome, Safari, Edge Chromium) */
            ::-webkit-scrollbar {
            width: 6px;               /* Ancho vertical */
            height: 6px;              /* Alto horizontal */
            }

            ::-webkit-scrollbar-thumb {
            background-color: rgba(0, 0, 0, 0.2); /* Color del "pulgar" */
            border-radius: 10px;
            }

            ::-webkit-scrollbar-track {
            background: transparent;  /* Fondo del track */
            }

            /* Firefox */
            * {
            scrollbar-width: thin;               /* 'auto', 'thin' o 'none' */
            scrollbar-color: rgba(0, 0, 0, 0.2) transparent;
            }


          /* BotÃ³n flotante */
.float-btn {
  position: fixed;
  right: 20px;
  bottom: 20px;
  width: 64px;
  height: 64px;
  border-radius: 50%;
  background: linear-gradient(135deg, #6c5ce7, #a29bfe);
  color: white;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 14px;
  font-weight: bold;
  cursor: pointer;
  box-shadow: 0 8px 20px rgba(0,0,0,0.3);
  transition: transform 0.2s ease, box-shadow 0.2s ease;
  z-index: 1000;
}
.float-btn:hover {
  transform: scale(1.1);
  box-shadow: 0 12px 28px rgba(0,0,0,0.35);
}

/* Panel de chat */
.chat-panel {
  position: fixed;
  right: 20px;
  bottom: 90px;
  width: 320px;
  max-height: 450px;
  background: #fff;
  border-radius: 16px;
  box-shadow: 0 12px 30px rgba(0,0,0,0.2);
  opacity: 0;
  transform: translateY(20px) scale(0.95);
  transition: all 0.3s ease;
  display: flex;
  flex-direction: column;
  pointer-events: none;
  z-index: 999;
  overflow: hidden;
}

/* Mostrar panel */
.chat-panel.show {
  opacity: 1;
  transform: translateY(0) scale(1);
  pointer-events: auto;
}

/* Header */
.chat-header {
  background: linear-gradient(135deg, #6c5ce7, #a29bfe);
  color: white;
  padding: 12px 16px;
  font-weight: bold;
  font-size: 16px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  border-top-left-radius: 16px;
  border-top-right-radius: 16px;
}
.chat-header button {
  background: none;
  border: none;
  color: white;
  font-size: 20px;
  cursor: pointer;
  transition: transform 0.2s ease;
}
.chat-header button:hover {
  transform: scale(1.2);
}

/* Body de mensajes */
.chat-body {
  flex: 1;
  padding: 12px;
  background: #f7f7fc;
  overflow-y: auto;
  display: flex;
  flex-direction: column;
  gap: 8px;
}

/* Mensajes */
.msg {
  padding: 8px 14px;
  border-radius: 20px;
  max-width: 80%;
  line-height: 1.4;
  font-size: 14px;
}
.msg.bot {
  background: #e4e6ef;
  color: #333;
  align-self: flex-start;
}
.msg.user {
  background: #6c5ce7;
  color: white;
  align-self: flex-end;
}

/* Input */
.chat-input {
  display: flex;
  padding: 10px;
  background: #fff;
  border-top: 1px solid #ddd;
}
.chat-input input {
  flex: 1;
  padding: 8px 14px;
  border-radius: 24px;
  border: 1px solid #ccc;
  font-size: 14px;
  outline: none;
  transition: border 0.2s ease;
}
.chat-input input:focus {
  border-color: #6c5ce7;
}
.chat-input button {
  margin-left: 8px;
  background: #6c5ce7;
  border: none;
  color: white;
  border-radius: 24px;
  padding: 0 16px;
  cursor: pointer;
  font-weight: bold;
  transition: background 0.2s ease;
}
.chat-input button:hover {
  background: #5a4bcf;
}

      
        </style>
  
    <script>
    
            let originalTitle = "ðŸ›ï¸ Velarisx Shop - Â¡Descubre lo mejor!";
            let hiddenTitle = "ðŸ˜¢ Â¡Vuelve, te extraÃ±amos!";
            let currentTitle = originalTitle;
            let index = 0;
            let interval;

            function startCarousel(titleText) {
                clearInterval(interval); // Limpiar intervalos anteriores
                let text = titleText + "  "; // Espacio para hacer loop
                index = 0;
                interval = setInterval(() => {
                    document.title = text.substring(index) + text.substring(0, index);
                    index = (index + 1) % text.length;
                }, 250); // Velocidad de animaciÃ³n (ajustable)
            }

            document.addEventListener("visibilitychange", function () {
                if (document.hidden) {
                    startCarousel(hiddenTitle); // Carrusel cuando se va
                } else {
                    startCarousel(originalTitle); // Carrusel cuando regresa
                }
            });

            // Iniciar el carrusel desde el inicio
            startCarousel(originalTitle);

            

    </script>


    
</head>
<body>

    
        {% block navbar %} {% endblock navbar %}

      
        {% block content %}

        
        {% endblock content %}

       <div class="float-btn" id="btnAsis">Asis</div>

<div class="chat-panel" id="chatPanel">
  <div class="chat-header">
    <span>Asis - Chatbot</span>
    <button id="closeChat">Ã—</button>
  </div>
  <div class="chat-body" id="chatBody">
    <div class="msg bot">Â¡Hola! Â¿CÃ³mo puedo ayudarte?</div>
  </div>
  <div class="chat-input">
    <input type="text" id="chatInput" placeholder="Escribe un mensaje...">
    <button id="sendBtn">Enviar</button>
  </div>
</div>


        {% block footer %} {% endblock footer %}
  

    <script src="{% static 'bootstrap/js/bootstrap.bundle.min.js' %}"></script>

  <script>
const btn = document.getElementById('btnAsis');
const panel = document.getElementById('chatPanel');
const close = document.getElementById('closeChat');
const body = document.getElementById('chatBody');
const input = document.getElementById('chatInput');
const sendBtn = document.getElementById('sendBtn');

// --- FunciÃ³n typing: mostrar mensaje letra por letra ---
function typeMessage(text, isBot = true) {
    const msgDiv = document.createElement('div');
    msgDiv.className = 'msg ' + (isBot ? 'bot' : 'user');
    body.appendChild(msgDiv);

    let index = 0;
    const typingInterval = setInterval(() => {
        msgDiv.textContent = text.substring(0, index + 1);
        index++;
        body.scrollTop = body.scrollHeight;

        if (index === text.length) {
            clearInterval(typingInterval);
        }
    }, 30); // 30ms por letra, ajustable
}

// --- Click en botÃ³n Asis ---
btn.addEventListener('click', ()=>{
    panel.classList.toggle('show');
    if(panel.classList.contains('show')) {
        initChatByContext(); // mensaje inicial con typing
    }
});

// --- Cerrar chat ---
close.addEventListener('click', ()=>{
    panel.classList.remove('show');
});

// --- Enviar mensajes ---
function sendMessage(){
    const text = input.value.trim();
    if(!text) return;

    // Mostrar mensaje del usuario
    const userMsg = document.createElement('div');
    userMsg.className = 'msg user';
    userMsg.textContent = text;
    body.appendChild(userMsg);

    input.value = '';
    body.scrollTop = body.scrollHeight;

    // --- Enviar a Django con fetch ---
    fetch("{% url 'chatbot_message' %}", {
        method: "POST",
        headers: {
            "Content-Type": "application/x-www-form-urlencoded",
            "X-CSRFToken": getCookie('csrftoken')  // Necesario para Django
        },
        body: `message=${encodeURIComponent(text)}`
    })
    .then(response => response.json())
    .then(data => {
        if(data.redirect){
            // Redirigir al navegador
            window.location.href = data.redirect;
        } else if(data.response){
            // Mostrar respuesta con efecto typing
            typeMessage("Asis: " + data.response);
        }
    })
    .catch(error => {
        console.error("Error enviando mensaje:", error);
    });
}

// --- FunciÃ³n para obtener CSRF token ---
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}


sendBtn.addEventListener('click', sendMessage);
input.addEventListener('keypress', (e)=>{
    if(e.key === 'Enter'){
        sendMessage();
    }
});

// --- FunciÃ³n para mensajes iniciales segÃºn URL/contexto ---
function initChatByContext() {
    let initialText = "Asis: Hola, Â¿cÃ³mo puedo ayudarte hoy?";
    const path = window.location.pathname;

    if (path === "/" || path.startsWith("/home")) {
        initialText = "Asis: Bienvenido al Home ðŸ , Â¿quieres ver las novedades?";
    } else if (path.startsWith("/perfil")) {
        initialText = "Asis: EstÃ¡s en tu perfil ðŸ‘¤, Â¿quieres actualizar tus datos?";
    } else if (path.startsWith("/shops")) {
        initialText = "Asis: AquÃ­ estÃ¡n las mejores ofertas ðŸ›ï¸ Â¿Quieres ayuda para buscar un producto?";
    }

    typeMessage(initialText);
}

// --- AutomatizaciÃ³n: mostrar el chatbot cada minuto ---
// Se abre automÃ¡ticamente, espera 20 segundos y se oculta
setInterval(()=>{
    panel.classList.add('show');
    initChatByContext(); // mensaje con typing
    setTimeout(()=>{
        panel.classList.remove('show');
    }, 20000); // visible 20 segundos
}, 60000); // cada 1 minuto
</script>

</body>
</html>