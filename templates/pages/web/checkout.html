{% extends "pages/web/base.html" %}
{% load static %}

{% block navbar %}
    {% include "components/web/navbar.html" %}
{% endblock navbar %}

{% block content %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<style>
    :root { --emerald: rgb(25,90,89); --bg-page: #f4f6f8; --card-bg: #ffffff; --border-color: #e2e8f0; }
    body { background-color: var(--bg-page); font-family: 'Inter', system-ui, sans-serif; }
    
    /* Layout */
    .step-title { font-size: 1.1rem; font-weight: 700; margin-bottom: 1.5rem; display: flex; align-items: center; gap: 10px; }
    .step-number { background: var(--emerald); color: white; width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.9rem; }
    
    /* Envio */
    .shipping-toggle { display: flex; gap: 1rem; margin-bottom: 1.5rem; }
    .shipping-option-label { flex: 1; cursor: pointer; }
    .shipping-option-card { background: white; border: 2px solid var(--border-color); border-radius: 12px; padding: 1rem; display: flex; align-items: center; justify-content: space-between; transition: 0.2s; }
    .shipping-option-input:checked + .shipping-option-card { border-color: var(--emerald); background-color: #f0fdf4; color: var(--emerald); }
    .badge-cost { background: #e2e8f0; color: #475569; padding: 4px 8px; border-radius: 6px; font-size: 0.8rem; font-weight: 700; }
    
    /* Direcciones */
    .address-card { background: var(--card-bg); border: 2px solid var(--border-color); border-radius: 12px; padding: 1.2rem; cursor: pointer; position: relative; }
    .hidden-radio:checked + .address-card { border-color: var(--emerald); background-color: #f0fdf4; }
    .check-mark { position: absolute; top: 10px; right: 10px; color: var(--emerald); display: none; }
    .hidden-radio:checked + .address-card .check-mark { display: block; }
    .btn-edit-addr { width: 35px; height: 35px; display: flex; align-items: center; justify-content: center; border-radius: 50%; background: #f1f5f9; color: #64748b; position: relative; z-index: 5; }
    
    /* Pagos */
    .payment-option { background: white; border: 2px solid var(--border-color); border-radius: 16px; padding: 1.5rem; cursor: pointer; height: 100%; display: flex; flex-direction: column; align-items: center; text-align: center; justify-content: center; transition: 0.2s; }
    .payment-option:hover { transform: translateY(-3px); box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
    .hidden-radio:checked + .payment-option { border-color: var(--emerald); box-shadow: 0 0 0 4px rgba(25,90,89,0.1); }
    .hidden-radio:checked + .payment-option i { color: var(--emerald); transform: scale(1.1); }
    .pay-icon { font-size: 2.5rem; margin-bottom: 0.5rem; color: #64748b; }
    
    /* Resumen */
    .summary-card { background: white; border-radius: 16px; padding: 2rem; box-shadow: 0 20px 40px rgba(0,0,0,0.06); position: sticky; top: 100px; }
    .btn-checkout { background: var(--emerald); color: white; width: 100%; padding: 1rem; border-radius: 10px; font-weight: 700; font-size: 1.1rem; border: none; transition: 0.3s; margin-top: 1rem; }
    .btn-checkout:hover { background: rgb(20, 75, 75); color: white; }
    .disabled-section { opacity: 0.5; pointer-events: none; filter: grayscale(1); }

    /* Modal Timer */
    .qr-timer-box { background-color: #fff3cd; color: #856404; border: 1px solid #ffeeba; padding: 8px 15px; border-radius: 50px; display: inline-flex; align-items: center; gap: 8px; font-weight: bold; font-family: monospace; font-size: 1.1rem; margin-top: 15px; }
    .qr-timer-icon { animation: pulse 1s infinite; }
    @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
</style>

<div class="container py-5" style="min-height: 85vh;">
    
    <div class="mb-5">
        <h2 class="fw-bold mb-1">Finalizar Compra</h2>
        <p class="text-muted">Estás a un paso de tener tu pedido.</p>
    </div>

    {% if messages %}
        {% for message in messages %}
            <div class="alert alert-info border-0 shadow-sm mb-4"><i class="bi bi-info-circle me-2"></i>{{ message }}</div>
        {% endfor %}
    {% endif %}

    <form method="post" action="{% url 'checkout' %}" id="checkout-form">
        {% csrf_token %}
        <input type="hidden" name="shipping_method_type" id="shipping_method_type" value="home">
        
        <div class="row g-5">
            <div class="col-lg-8">
                
                <div class="mb-5">
                    <div class="step-title"><span class="step-number">1</span> Método de Entrega</div>
                    <div class="shipping-toggle">
                        <label class="shipping-option-label">
                            <input type="radio" name="shipping_selector" value="home" class="shipping-option-input hidden-radio" checked onchange="toggleShippingView('home')">
                            <div class="shipping-option-card">
                                <div><i class="bi bi-truck me-2"></i> Envío a Domicilio</div>
                                <span class="badge-cost">Gratis</span>
                            </div>
                        </label>
                        <label class="shipping-option-label">
                            <input type="radio" name="shipping_selector" value="pickup" class="shipping-option-input hidden-radio" onchange="toggleShippingView('pickup')">
                            <div class="shipping-option-card">
                                <div><i class="bi bi-shop me-2"></i> Retiro en Punto</div>
                                <span class="badge-cost">Gratis</span>
                            </div>
                        </label>
                    </div>

                    <div id="view-home-delivery" class="animate__animated animate__fadeIn">
                        {% if default_address %}
                            <label class="w-100 position-relative mb-2">
                                <input type="radio" name="address" value="{{ default_address.id }}" class="hidden-radio address-radio" checked>
                                <div class="address-card">
                                    <i class="bi bi-check-circle-fill check-mark fs-5"></i>
                                    <div class="d-flex align-items-center gap-3">
                                        <div class="bg-light p-3 rounded-circle text-muted"><i class="bi bi-house-door-fill fs-4"></i></div>
                                        <div class="flex-grow-1">
                                            <div class="badge bg-success bg-opacity-10 text-success mb-1">Predeterminada</div>
                                            <h6 class="fw-bold mb-0 text-dark">{{ default_address.main_street }} {{ default_address.house_number }}</h6>
                                            <small class="text-muted">{{ default_address.localidad }}</small>
                                        </div>
                                        <a href="{% url 'edit_address' default_address.id %}" class="btn-edit-addr"><i class="bi bi-pencil-fill small"></i></a>
                                    </div>
                                </div>
                            </label>
                        {% endif %}
                        {% for address in other_addresses %}
                            <label class="w-100 position-relative mb-2">
                                <input type="radio" name="address" value="{{ address.id }}" class="hidden-radio address-radio">
                                <div class="address-card">
                                    <i class="bi bi-check-circle-fill check-mark fs-5"></i>
                                    <div class="d-flex align-items-center gap-3">
                                        <div class="bg-light p-3 rounded-circle text-muted"><i class="bi bi-geo-alt-fill fs-4"></i></div>
                                        <div class="flex-grow-1">
                                            <h6 class="fw-bold mb-0 text-dark">{{ address.main_street }} {{ address.house_number }}</h6>
                                            <small class="text-muted">{{ address.localidad }}</small>
                                        </div>
                                        <a href="{% url 'edit_address' address.id %}" class="btn-edit-addr"><i class="bi bi-pencil-fill small"></i></a>
                                    </div>
                                </div>
                            </label>
                        {% endfor %}
                         <a href="{% url 'add_address' %}" class="btn btn-outline-dark border-dashed w-100 py-2 mt-2" style="border-style: dashed;"><i class="bi bi-plus-lg me-1"></i> Nueva dirección</a>
                    </div>

                    <div id="view-pickup-point" class="d-none animate__animated animate__fadeIn">
                        <div id="map-container"><div id="map" style="width: 100%; height: 100%;"></div></div>
                        <div id="pickup-list">
                            <label class="w-100 mb-2">
                                <input type="radio" name="pickup_point_id" value="point_1" class="hidden-radio pickup-radio">
                                <div class="pickup-point-item d-flex justify-content-between align-items-center">
                                    <div><h6 class="fw-bold mb-0">Sucursal Central</h6><small class="text-muted">Centro (0.5 km)</small></div>
                                </div>
                            </label>
                        </div>
                    </div>
                </div>

                <div id="payment-section" class="disabled-section">
                    <div class="step-title"><span class="step-number">2</span> Método de Pago</div>
                    <div class="row g-3">
                        <div class="col-md-4 d-none d-lg-block">
                            <label class="w-100 h-100">
                                <input type="radio" name="payment_method" value="qr_modal" class="hidden-radio payment-radio">
                                <div class="payment-option">
                                    <i class="bi bi-qr-code pay-icon"></i>
                                    <h6 class="fw-bold mb-1">Escanear QR</h6>
                                    <small class="text-muted lh-sm">Paga con celular</small>
                                </div>
                            </label>
                        </div>
                        <div class="col-md-4 col-6">
                            <label class="w-100 h-100">
                                <input type="radio" name="payment_method" value="card_manual" class="hidden-radio payment-radio">
                                <div class="payment-option">
                                    <i class="bi bi-credit-card-2-front pay-icon"></i>
                                    <h6 class="fw-bold mb-1">Tarjeta</h6>
                                    <small class="text-muted lh-sm">Crédito/Débito</small>
                                </div>
                            </label>
                        </div>
                        <div class="col-md-4 col-6">
                            <label class="w-100 h-100">
                                <input type="radio" name="payment_method" value="mp_redirect" class="hidden-radio payment-radio">
                                <div class="payment-option">
                                    <i class="bi bi-box-arrow-up-right pay-icon" style="color: #009ee3;"></i>
                                    <h6 class="fw-bold mb-1">Mercado Pago</h6>
                                    <small class="text-muted lh-sm">Web Oficial</small>
                                </div>
                            </label>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-4">
                <div class="summary-card">
                    <h5 class="fw-bold mb-4">Resumen de Orden</h5>
                    <div class="d-flex justify-content-between mb-2 text-muted"><span>Subtotal</span><span>${{ subtotal_original }}</span></div>
                    <div class="d-flex justify-content-between mb-2 text-muted"><span>Envío</span><span class="text-success fw-bold">Gratis</span></div>
                    {% if cart.coupon %}
                        <div class="d-flex justify-content-between mb-2 text-success"><span>Descuento</span><span>- ${{ cart.coupon.discount_value }}</span></div>
                    {% endif %}
                    <hr class="my-4">
                    <div class="d-flex justify-content-between align-items-end mb-4">
                        <span class="h5 fw-bold mb-0">Total</span>
                        <span class="h2 fw-bold mb-0 text-dark">${{ total_price|floatformat:2 }}</span>
                    </div>
                    <button type="submit" id="btn-submit-main" class="btn-checkout shadow-sm">CONFIRMAR Y PAGAR</button>
                    <div class="mt-4 text-center"><small class="text-muted">Procesado por</small><br><img src="https://logotipoz.com/wp-content/uploads/2021/10/version-horizontal-large-logo-mercado-pago.webp" alt="MP" style="height: 25px; opacity: 0.6;"></div>
                </div>
            </div>
        </div>
    </form>
</div>

<div class="modal fade" id="qrPaymentModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content rounded-4 border-0 shadow-lg">
            
            <div class="modal-header border-0 pb-0 justify-content-center pt-4" style="background: linear-gradient(180deg, #f8f9fa 0%, #ffffff 100%);">
                 <div class="text-center w-100">
                     <div class="d-inline-flex align-items-center justify-content-center bg-primary bg-opacity-10 text-primary rounded-circle mb-3" style="width: 60px; height: 60px;">
                        <i class="bi bi-qr-code-scan fs-3"></i>
                     </div>
                     <h5 class="modal-title fw-bold text-dark">Escanea para Pagar</h5>
                 </div>
            </div>

            <div class="modal-body text-center p-4 pt-2">
                <p class="text-muted mb-4 px-3" style="font-size: 0.95rem;">
                    Usa <strong>Mercado Pago</strong>, <strong>Modo</strong> o tu <strong>App Bancaria</strong> favorita para escanear el código.
                </p>
                
                <div class="d-flex justify-content-center mb-3">
                    <div id="modal-qrcode" class="p-2 bg-white border rounded shadow-sm"></div>
                </div>

                <h3 class="fw-bold mb-0" id="modal-total-price">$0.00</h3>

                <div class="qr-timer-box">
                    <i class="bi bi-stopwatch qr-timer-icon"></i>
                    <span id="time-display">15:00</span>
                </div>
            </div>

            <div class="modal-footer border-0 justify-content-center pb-4 pt-0">
                 <a href="{% url 'checkout' %}" class="btn btn-outline-danger rounded-pill px-4 fw-bold">
                    <i class="bi bi-x-circle me-2"></i>Cancelar y volver
                 </a>
            </div>
        </div>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

<script>
    // MAPA
    let map = null;
    let mapInitialized = false;
    function initMap() {
        if(mapInitialized) return;
        map = L.map('map').setView([-34.6037, -58.3816], 14);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
        L.marker([-34.6037, -58.3816]).addTo(map).bindPopup('Sucursal Central');
        mapInitialized = true;
    }
    function toggleShippingView(type) {
        document.getElementById('shipping_method_type').value = type;
        if (type === 'home') {
            document.getElementById('view-home-delivery').classList.remove('d-none');
            document.getElementById('view-pickup-point').classList.add('d-none');
            document.querySelectorAll('.address-radio').forEach(r => r.disabled = false);
            document.querySelectorAll('.pickup-radio').forEach(r => {r.disabled = true; r.checked = false;});
        } else {
            document.getElementById('view-home-delivery').classList.add('d-none');
            document.getElementById('view-pickup-point').classList.remove('d-none');
            document.querySelectorAll('.address-radio').forEach(r => {r.disabled = true; r.checked = false;});
            document.querySelectorAll('.pickup-radio').forEach(r => r.disabled = false);
            if (!mapInitialized) setTimeout(initMap, 200);
        }
        checkPaymentSectionStatus();
    }
    function checkPaymentSectionStatus() {
        const type = document.getElementById('shipping_method_type').value;
        let isValid = (type === 'home') ? document.querySelector('.address-radio:checked') : document.querySelector('.pickup-radio:checked');
        const sec = document.getElementById('payment-section');
        const radios = document.querySelectorAll('.payment-radio');
        if (isValid) { sec.classList.remove('disabled-section'); radios.forEach(r => r.disabled = false); } 
        else { sec.classList.add('disabled-section'); radios.forEach(r => {r.disabled = true; r.checked = false;}); }
    }

    // TIMER
    function startTimer(duration, display) {
        let timer = duration, minutes, seconds;
        let interval = setInterval(function () {
            minutes = parseInt(timer / 60, 10);
            seconds = parseInt(timer % 60, 10);

            minutes = minutes < 10 ? "0" + minutes : minutes;
            seconds = seconds < 10 ? "0" + seconds : seconds;

            display.textContent = minutes + ":" + seconds;

            if (--timer < 0) {
                clearInterval(interval);
                Swal.fire({
                    icon: 'warning',
                    title: 'Tiempo expirado',
                    text: 'El código QR ha vencido. Por favor genera uno nuevo.',
                    confirmButtonText: 'Entendido'
                }).then(() => {
                    window.location.href = "{% url 'checkout' %}";
                });
            }
        }, 1000);
        return interval;
    }

    document.addEventListener('DOMContentLoaded', function() {
        document.querySelectorAll('.address-radio, .pickup-radio').forEach(r => r.addEventListener('change', checkPaymentSectionStatus));
        checkPaymentSectionStatus();
        
        document.getElementById('checkout-form').addEventListener('submit', function(e) {
            const btn = document.getElementById('btn-submit-main');
            btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Procesando...';
            btn.classList.add('disabled');
        });

        // --- LÓGICA MODAL QR (Server Trigger) ---
        {% if qr_data_active %}
            const qrData = JSON.parse('{{ qr_data|escapejs }}');
            
            // 1. Instanciar Modal
            const qrModal = new bootstrap.Modal(document.getElementById('qrPaymentModal'));
            
            // 2. Dibujar QR
            const qrDiv = document.getElementById("modal-qrcode");
            qrDiv.innerHTML = "";
            new QRCode(qrDiv, {
                text: qrData.url,
                width: 200, height: 200,
                colorDark : "#000000", colorLight : "#ffffff",
                correctLevel : QRCode.CorrectLevel.M
            });

            document.getElementById('modal-total-price').innerText = "$" + qrData.total.toFixed(2);
            qrModal.show();

            // 3. Iniciar Temporizador
            const timeDisplay = document.querySelector('#time-display');
            const totalSeconds = (qrData.minutes || 15) * 60;
            const timerInterval = startTimer(totalSeconds, timeDisplay);

            // 4. Iniciar Polling (Verificar pago)
            // IMPORTANTE: Usamos la URL generada por Django que ahora incluye el prefijo correcto
            const checkUrl = qrData.check_url; 
            
            console.log("Esperando pago en: " + checkUrl);

            let checkInterval = setInterval(() => {
                fetch(checkUrl)
                    .then(r => {
                         if (!r.ok) throw new Error("404 o Error");
                         return r.json();
                    })
                    .then(d => {
                        if (d.status === 'approved') {
                            clearInterval(checkInterval);
                            clearInterval(timerInterval);
                            qrModal.hide();
                            Swal.fire({
                                icon: 'success',
                                title: '¡Pago Confirmado!',
                                text: 'Tu orden fue procesada.',
                                timer: 2000,
                                showConfirmButton: false
                            }).then(() => {
                                window.location.href = d.redirect_url;
                            });
                        }
                    })
                    .catch(err => console.log("Polling...", err));
            }, 3000);
        {% endif %}
    });
</script>
{% endblock content %}