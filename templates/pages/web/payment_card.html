{% extends "pages/web/base.html" %}
{% load static %}

{% block content %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">

<div class="container py-5" style="min-height: 85vh;">
    <div class="row justify-content-center">
        <div class="col-lg-6">
            
            <div class="mb-4">
                <a href="{% url 'checkout' %}" class="text-decoration-none text-muted mb-3 d-inline-block">
                    <i class="bi bi-arrow-left"></i> Volver al Checkout
                </a>
                <h3 class="fw-bold">Pago con Tarjeta</h3>
                <p class="text-muted">Ingresa los datos de tu tarjeta de forma segura.</p>
            </div>

            <div class="card shadow-sm border-0 rounded-4">
                <div class="card-body p-4">
                    <div id="paymentBrick_container"></div>
                </div>
            </div>

            <div id="loading-overlay" class="d-none text-center mt-4">
                <div class="spinner-border text-success" role="status"></div>
                <p class="mt-2 text-muted fw-bold">Procesando pago con el banco...</p>
            </div>

        </div>
        
        <div class="col-lg-4 mt-5 mt-lg-0">
            <div class="card border-0 bg-light rounded-4 p-4">
                <h5 class="fw-bold mb-3">Resumen</h5>
                <div class="d-flex justify-content-between mb-2">
                    <span>Total a pagar:</span>
                    <span class="fw-bold">${{ cart.total_price|floatformat:2 }}</span>
                </div>
                <hr>
                <div class="small text-muted">
                    <i class="bi bi-shield-lock-fill text-success me-1"></i>
                    Tus datos están protegidos por Mercado Pago.
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://sdk.mercadopago.com/js/v2"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
    const mp = new MercadoPago("{{ mp_public_key }}", {
        locale: 'es-AR'
    });

    const bricksBuilder = mp.bricks();

    // --- TRADUCTOR DE ERRORES DE MERCADO PAGO ---
    function traducirError(statusDetail) {
        const errores = {
            "cc_rejected_bad_filled_card_number": "Revisa el número de tarjeta.",
            "cc_rejected_bad_filled_date": "Revisa la fecha de vencimiento.",
            "cc_rejected_bad_filled_other": "Revisa los datos.",
            "cc_rejected_bad_filled_security_code": "Revisa el código de seguridad (CVV).",
            "cc_rejected_blacklist": "No pudimos procesar tu pago.",
            "cc_rejected_call_for_authorize": "Debes autorizar el pago con tu banco.",
            "cc_rejected_card_disabled": "Llama a tu banco para activar tu tarjeta.",
            "cc_rejected_card_error": "No pudimos procesar tu pago.",
            "cc_rejected_duplicated_payment": "Ya hiciste un pago por ese valor.",
            "cc_rejected_high_risk": "El pago fue rechazado por seguridad.",
            "cc_rejected_insufficient_amount": "Tu tarjeta no tiene fondos suficientes.",
            "cc_rejected_max_attempts": "Llegaste al límite de intentos permitidos.",
            "pending_contingency": "Estamos procesando tu pago. No vuelvas a intentar todavía.",
            "pending_review_manual": "Estamos revisando tu pago, te avisaremos pronto."
        };
        return errores[statusDetail] || "El pago fue rechazado por el banco. Intenta con otra tarjeta.";
    }

    const renderPaymentBrick = async (bricksBuilder) => {
        let montoString = "{{ cart.total_price|stringformat:'.2f' }}".replace(',', '.');
        let monto = parseFloat(montoString);

        const settings = {
            initialization: {
                amount: monto,
                payer: { email: "{{ request.user.email }}" },
            },
            customization: {
                paymentMethods: {
                    maxInstallments: 12,
                    ticket: "all",
                    bankTransfer: "all",
                    creditCard: "all",
                    debitCard: "all",
                    mercadoPago: "all",
                },
                visual: {
                    style: { theme: "default" }
                },
            },
            callbacks: {
                onReady: () => { console.log("Brick listo."); },
                onSubmit: ({ selectedPaymentMethod, formData }) => {
                    // Mostrar Spinner
                    document.getElementById('loading-overlay').classList.remove('d-none');
                    // Deshabilitar interacción con el brick para evitar doble click
                    document.getElementById('paymentBrick_container').style.pointerEvents = 'none';
                    document.getElementById('paymentBrick_container').style.opacity = '0.5';

                    return new Promise((resolve, reject) => {
                        fetch("{% url 'payment_card' %}", {
                            method: "POST",
                            headers: {
                                "Content-Type": "application/json",
                                "X-CSRFToken": "{{ csrf_token }}",
                            },
                            body: JSON.stringify(formData)
                        })
                        .then((response) => response.json())
                        .then((response) => {
                            // Ocultar Spinner
                            document.getElementById('loading-overlay').classList.add('d-none');
                            document.getElementById('paymentBrick_container').style.pointerEvents = 'auto';
                            document.getElementById('paymentBrick_container').style.opacity = '1';

                            if (response.status === 'approved') {
                                // ÉXITO: Alerta bonita y Redirección
                                Swal.fire({
                                    icon: 'success',
                                    title: '¡Pago Aprobado!',
                                    text: 'Tu orden se ha generado correctamente.',
                                    showConfirmButton: false,
                                    timer: 2000
                                }).then(() => {
                                    window.location.href = response.redirect_url;
                                });
                                resolve();
                            } else {
                                // ERROR: Alerta bonita con mensaje traducido
                                let mensajeError = traducirError(response.status_detail);
                                
                                Swal.fire({
                                    icon: 'error',
                                    title: 'Pago Rechazado',
                                    text: mensajeError,
                                    confirmButtonColor: '#d33',
                                    confirmButtonText: 'Intentar de nuevo'
                                });
                                reject();
                            }
                        })
                        .catch((error) => {
                            document.getElementById('loading-overlay').classList.add('d-none');
                            document.getElementById('paymentBrick_container').style.pointerEvents = 'auto';
                            document.getElementById('paymentBrick_container').style.opacity = '1';
                            
                            Swal.fire({
                                icon: 'error',
                                title: 'Error de conexión',
                                text: 'Verifica tu conexión a internet e inténtalo nuevamente.'
                            });
                            reject();
                        });
                    });
                },
                onError: (error) => { console.error("Error Brick:", error); },
            },
        };

        window.paymentBrickController = await bricksBuilder.create(
            "payment",
            "paymentBrick_container",
            settings
        );
    };

    renderPaymentBrick(bricksBuilder);
</script>
{% endblock content %}