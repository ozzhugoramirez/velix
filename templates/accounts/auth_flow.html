<!-- templates/accounts/auth_flow.html -->
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Acceso / Registro</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <!-- Bootstrap & Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">

  <style>
    :root {
      /* Paleta solicitada: esmeralda profundo + dorado metálico */
      --emerald-1: #10b981;         /* emerald */
      --emerald-2: #059669;         /* deep emerald */
      --emerald-3: #065f46;         /* darker */
      --gold-1: #d6b36a;            /* metallic gold light */
      --gold-2: #b68a2a;            /* metallic gold mid */
      --gold-3: #8c6b1f;            /* metallic gold dark */

      --brand: var(--emerald-2);
      --ink: #0f172a;
      --muted: #64748b;
      --ring: rgba(16,185,129,.28); /* emerald ring */
      --bg: #f5f7fb;
      --card: #ffffff;
    }
    * { font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Helvetica, Arial, sans-serif; }
    body { background: var(--bg); color: var(--ink); }

    .shell { max-width: 980px; margin: 0 auto; padding: clamp(20px, 5vw, 48px) 16px; }
    .auth { display: grid; grid-template-columns: 1fr; background: var(--card); border-radius: 22px; border: 1px solid #e2e8f0; box-shadow: 0 18px 50px rgba(2,6,23,.08); overflow: clip; }
    @media (min-width: 992px){ .auth { grid-template-columns: .95fr 1.05fr; } }

    /* Lado visual con acento esmeralda/dorado */
    .side { position: relative; padding: clamp(24px, 4vw, 40px); background: linear-gradient(135deg, #ecfdf5, #fefce8); }
    .side::after { content: ""; position: absolute; inset: 0; background:
      radial-gradient(600px 280px at 0% 100%, rgba(214,179,106,.25), transparent 60%),
      radial-gradient(600px 280px at 100% 0%, rgba(16,185,129,.18), transparent 60%);
      pointer-events: none; }
    .mark { width: 56px; height: 56px; border-radius: 14px; background: linear-gradient(135deg, rgba(16,185,129,.12), rgba(214,179,106,.14)); display: grid; place-items: center; border: 1px solid #d1fae5; color: var(--emerald-2); box-shadow: inset 0 0 0 1px rgba(214,179,106,.45); }
    .h1 { font-size: clamp(1.25rem, 2.2vw, 1.6rem); font-weight: 800; margin: 10px 0 0; letter-spacing: .2px; }
    .lead { color: var(--muted); margin: 6px 0 0; }

    /* Cuerpo (formularios) */
    .body { padding: clamp(18px, 4vw, 36px); }

    .stepbar { height: 6px; background: #e2e8f0; border-radius: 999px; overflow: hidden; margin-bottom: 16px; }
    .stepbar > span { display:block; height:100%; background: linear-gradient(90deg, var(--gold-1), var(--emerald-2)); width:25%; transition: width .3s ease; }

    /* Inputs (alineación perfecta con ícono @) */
    .body input[type="text"],
    .body input[type="email"],
    .body input[type="password"],
    .body input[type="number"],
    .body select,
    .body .form-control {
      width: 100%; background: #fff; border: 1px solid #e2e8f0; border-radius: 12px; padding: .8rem 1rem; outline: none; transition: box-shadow .2s ease, border-color .2s ease; line-height: 1.25; }
    .input-group { align-items: stretch; }
    .input-group>.form-control, .input-group-text { height: 48px; }
    .input-group-text { border-radius: 12px 0 0 12px; border: 1px solid #e2e8f0; background: #fff; display: inline-flex; align-items: center; justify-content: center; }
    .body input:focus, .body select:focus, .form-control:focus { border-color: var(--ring); box-shadow: 0 0 0 6px rgba(16,185,129,.12); }

    /* Botones con esmeralda/dorado */
    .btn-primary { background: linear-gradient(180deg, var(--emerald-1), var(--emerald-2)); border: 0; border-radius: 12px; padding: .95rem 1rem; font-weight: 800; letter-spacing:.2px; }
    .btn-primary:hover { filter: brightness(1.02); transform: translateY(-1px); }
    .btn-ghost { border-radius: 12px; padding: .9rem 1rem; font-weight: 800; background: linear-gradient(180deg, #fff, #fff); color: var(--gold-3); border: 1px solid var(--gold-2); box-shadow: 0 1px 0 rgba(214,179,106,.35) inset; }
    .btn-ghost:hover { background: linear-gradient(180deg, #fffdf4, #fff7e0); }

    .muted { color: var(--muted); font-size: .9rem; }

    /* OTP: cajas grandes para código */
    .otp { display: grid; grid-template-columns: repeat(6, 1fr); gap: 10px; }
    .otp input { text-align: center; font-size: 1.25rem; letter-spacing: .08em; padding: .85rem 0; }

    .fade { animation: fade .4s ease both; }
    @keyframes fade { from {opacity:0; transform: translateY(6px);} to {opacity:1; transform: translateY(0);} }
  </style>
</head>
<body>
  <main class="shell">
    <section class="auth">
      <!-- Lado visual -->
      <div class="side d-flex align-items-start gap-3">
        <div class="mark"><i class="bi bi-shield-lock"></i></div>
        <div>
          <h1 class="h1">Acceso a tu cuenta</h1>
          <p class="lead">Autenticación clara y segura.</p>
        </div>
      </div>

      <!-- Formularios -->
      <div class="body">
        <div class="stepbar" aria-hidden="true">
          <span style="width:
            {% if step == 'email' %}25%
            {% elif step == 'password' %}50%
            {% elif step == 'code' %}75%
            {% elif step == 'register' %}90%
            {% else %}25%{% endif %}"></span>
        </div>

        {% if messages %}
          <div class="mb-3 fade">
            {% for msg in messages %}
              <div class="alert alert-{{ msg.tags }} mb-2" role="alert">{{ msg }}</div>
            {% endfor %}
          </div>
        {% endif %}

        <!-- STEP: EMAIL -->
        {% if step == 'email' %}
          <header class="mb-3">
            <h2 class="h5 mb-1">Ingresá tu correo</h2>
            <p class="muted">Debe ser un correo <strong>válido</strong> (ej: <em>nombre@dominio.com</em>).</p>
          </header>

          <form method="post" class="vstack gap-3 fade" id="emailForm" novalidate>
            {% csrf_token %}
            <input type="hidden" name="action" value="submit_email">
            <input type="hidden" name="next" value="{{ next|default:'' }}">

            <div class="form-group">
              <label class="form-label" for="id_email"><i class="bi bi-envelope me-1"></i> Correo electrónico</label>
              <div class="input-group">
                <span class="input-group-text"><i class="bi bi-at"></i></span>
                {{ email_form.email }}
              </div>
              <div id="emailInvalid" class="text-danger small mt-2" style="display:none"><i class="bi bi-exclamation-triangle me-1"></i> Ingresá un correo válido.</div>
              <div class="muted mt-1">Usaremos este correo para continuar el acceso.</div>
            </div>

            <!-- Botón principal neutral -->
            <button class="btn btn-primary w-100" id="emailSubmit" type="submit">Continuar</button>

            <!-- Acción alternativa: login sin contraseña (no redirige por ahora) -->
            <a href="{% url 'magic_start' %}"
                role="button"
                style="
                  display:inline-flex; align-items:center; justify-content:center;
                  width:100%; padding:0.9rem 1rem; border-radius:12px;
                  border:1px solid #b68a2a; background:#ffffff;
                  text-decoration:none; color:#8c6b1f; font-weight:800; line-height:1;
                  box-shadow:0 1px 0 rgba(214,179,106,.35) inset;
                  transition:transform .15s ease, filter .15s ease;
                "
                onmouseover="this.style.filter='brightness(1.02)';this.style.transform='translateY(-1px)';"
                onmouseout="this.style.filter='';this.style.transform='';">
                <i class="bi bi-magic" style="margin-right:.5rem;"></i>
                Ingresar sin contraseña
              </a>

          </form>
        {% endif %}

        <!-- STEP: PASSWORD -->
        {% if step == 'password' %}
          <header class="mb-3">
            <h2 class="h5 mb-1">Tu contraseña</h2>
            <p class="muted">Correo: <strong>{{ email }}</strong></p>
          </header>
          <form method="post" class="vstack gap-3 fade" novalidate>
            {% csrf_token %}
            <input type="hidden" name="action" value="submit_password">
            <input type="hidden" name="next" value="{{ next|default:'' }}">
            <div class="form-group">
              <label class="form-label" for="id_password"><i class="bi bi-key me-1"></i> Contraseña</label>
              <div class="input-group">
                <span class="input-group-text"><i class="bi bi-shield-lock"></i></span>
                {{ password_form.password }}
                <button class="btn btn-outline-secondary" type="button" id="togglePwd" aria-label="Mostrar/ocultar contraseña"><i class="bi bi-eye"></i></button>
              </div>
              <div class="text-danger small mt-1">{{ password_form.password.errors }}</div>
            </div>
            <button class="btn btn-primary w-100" type="submit">Entrar</button>
          </form>
        {% endif %}

        <!-- STEP: CODE -->
        {% if step == 'code' %}
          <header class="mb-3 d-flex align-items-center justify-content-between">
            <div>
              <h2 class="h5 mb-1">Ingresá el código</h2>
              <p class="muted mb-0">Enviado a <strong>{{ email }}</strong></p>
            </div>
            <!-- Volver a ingresar otro correo -->
            <form id="restartEmail" method="post" class="ms-2">
              {% csrf_token %}
              <input type="hidden" name="action" value="submit_email">
              <button class="btn btn-ghost btn-sm" type="submit" title="Ingresar otro correo">
                <i class="bi bi-arrow-left-circle me-1"></i> Ingresar otro correo
              </button>
            </form>
          </header>

          <!-- Mantiene widget original oculto y lo sincroniza con OTP -->
          <form method="post" class="vstack gap-3 fade" id="codeForm" novalidate>
            {% csrf_token %}
            <input type="hidden" name="action" value="submit_code">
            <input type="hidden" name="next" value="{{ next|default:'' }}">

            <div class="visually-hidden" aria-hidden="true">{{ code_form.code }}</div>

            <div class="otp" aria-label="Código de verificación de 6 dígitos">
              <input inputmode="numeric" pattern="[0-9]*" maxlength="1" class="form-control" id="otp1">
              <input inputmode="numeric" pattern="[0-9]*" maxlength="1" class="form-control" id="otp2">
              <input inputmode="numeric" pattern="[0-9]*" maxlength="1" class="form-control" id="otp3">
              <input inputmode="numeric" pattern="[0-9]*" maxlength="1" class="form-control" id="otp4">
              <input inputmode="numeric" pattern="[0-9]*" maxlength="1" class="form-control" id="otp5">
              <input inputmode="numeric" pattern="[0-9]*" maxlength="1" class="form-control" id="otp6">
            </div>
            <div class="text-danger small" id="codeErrors">{{ code_form.code.errors }}</div>
            <div class="muted">Podés pegar el código completo y lo acomodamos automáticamente.</div>

            <button class="btn btn-primary w-100" type="submit">Verificar código</button>
          </form>

          <form method="post" class="mt-3 text-center" onsubmit="disableResend(this)" novalidate>
            {% csrf_token %}
            <input type="hidden" name="action" value="submit_email">
            <input type="hidden" name="email" value="{{ email }}">
            <input type="hidden" name="next" value="{{ next|default:'' }}">
            <button id="resendBtn" class="btn btn-link p-0" type="submit"><i class="bi bi-arrow-repeat me-1"></i> Reenviar código</button>
            <div class="small text-muted mt-1" id="resendHint"></div>
          </form>
        {% endif %}

        <!-- STEP: REGISTER -->
        {% if step == 'register' %}
          <header class="mb-3">
            <h2 class="h5 mb-1">Crear cuenta</h2>
            <p class="muted">Correo verificado: <strong>{{ email }}</strong></p>
          </header>
          <form method="post" class="vstack gap-3 fade" novalidate>
            {% csrf_token %}
            <input type="hidden" name="action" value="submit_register">
            <input type="hidden" name="next" value="{{ next|default:'' }}">

            <div class="row g-3">
              <div class="col-12 col-md-6">
                <label class="form-label" for="id_first_name"><i class="bi bi-person me-1"></i> Nombre</label>
                {{ register_form.first_name }}
                <div class="text-danger small mt-1">{{ register_form.first_name.errors }}</div>
              </div>
              <div class="col-12 col-md-6">
                <label class="form-label" for="id_last_name"><i class="bi bi-person-badge me-1"></i> Apellido</label>
                {{ register_form.last_name }}
                <div class="text-danger small mt-1">{{ register_form.last_name.errors }}</div>
              </div>
            </div>

            <div>
              <label class="form-label" for="id_password1"><i class="bi bi-lock me-1"></i> Contraseña</label>
              <div class="input-group">
                <span class="input-group-text"><i class="bi bi-shield-lock"></i></span>
                {{ register_form.password1 }}
                <button class="btn btn-outline-secondary" type="button" id="togglePwd1" aria-label="Mostrar/ocultar contraseña"><i class="bi bi-eye"></i></button>
              </div>
              <div class="text-danger small mt-1">{{ register_form.password1.errors }}</div>
            </div>

            <div>
              <label class="form-label" for="id_password2"><i class="bi bi-lock-fill me-1"></i> Repetir contraseña</label>
              <div class="input-group">
                <span class="input-group-text"><i class="bi bi-shield-lock"></i></span>
                {{ register_form.password2 }}
                <button class="btn btn-outline-secondary" type="button" id="togglePwd2" aria-label="Mostrar/ocultar contraseña"><i class="bi bi-eye"></i></button>
              </div>
              <div class="text-danger small mt-1">{{ register_form.password2.errors }}</div>
              <div class="muted mt-1">La contraseña debe coincidir en ambos campos.</div>
            </div>

            <button class="btn btn-primary w-100" type="submit">Crear cuenta</button>
          </form>
        {% endif %}

        <hr class="my-4">
        <div class="d-flex flex-column flex-sm-row gap-2 justify-content-between align-items-start align-items-sm-center">
          <span class="muted"><i class="bi bi-lock-fill me-1"></i> Tus datos se transmiten de forma segura.</span>
          <div class="d-flex gap-3">
            <a class="link" href="#">Términos</a>
            <a class="link" href="#">Privacidad</a>
            <a class="link" href="#">Ayuda</a>
          </div>
        </div>
      </div>
    </section>
  </main>

  <script>
    // Toggle password visibility
    const toggleVisibility = (btnId, inputId) => {
      const btn = document.getElementById(btnId);
      const input = document.getElementById(inputId);
      if (!btn || !input) return;
      btn.addEventListener('click', () => {
        const isPwd = input.getAttribute('type') === 'password';
        input.setAttribute('type', isPwd ? 'text' : 'password');
        btn.querySelector('i').className = isPwd ? 'bi bi-eye-slash' : 'bi bi-eye';
      });
    };
    toggleVisibility('togglePwd', 'id_password');
    toggleVisibility('togglePwd1', 'id_password1');
    toggleVisibility('togglePwd2', 'id_password2');

    // Validación simple de correo (sin tocar el widget Django)
    const emailInput = document.getElementById('id_email');
    const emailInvalid = document.getElementById('emailInvalid');
    const emailForm = document.getElementById('emailForm');
    function isValidEmail(v){ return (/^[^\s@]+@[^\s@]+\.[^\s@]{2,}$/).test(v || ''); }
    function mark(valido){ if(!emailInput||!emailInvalid) return; emailInput.classList.toggle('is-invalid', !valido); emailInvalid.style.display = valido ? 'none' : 'block'; }
    if (emailInput){ emailInput.addEventListener('input', () => mark(isValidEmail(emailInput.value))); emailInput.addEventListener('blur', () => mark(isValidEmail(emailInput.value))); }
    if (emailForm){ emailForm.addEventListener('submit', (e) => { if (!emailInput || !isValidEmail(emailInput.value)){ e.preventDefault(); mark(false); emailInput?.focus(); } }); }

    // Botón "Ingresar sin contraseña" (por ahora sin navegación). Feedback visual corto
    const passlessBtn = document.getElementById('passlessBtn');
    if (passlessBtn){ passlessBtn.addEventListener('click', (e) => { e.preventDefault(); passlessBtn.classList.add('disabled'); setTimeout(() => passlessBtn.classList.remove('disabled'), 900); }); }

    // OTP: auto-avance, backspace y pegar completo
    const otpIds = ['otp1','otp2','otp3','otp4','otp5','otp6'];
    const otpInputs = otpIds.map(id => document.getElementById(id)).filter(Boolean);
    const hiddenCode = document.getElementById('id_code');
    const onlyDigits = (str) => (str||'').replace(/\D/g,'');
    const syncHidden = () => { if (!hiddenCode || otpInputs.length !== 6) return; hiddenCode.value = otpInputs.map(i => i.value).join(''); };
    otpInputs.forEach((input, idx) => {
      input?.addEventListener('input', () => { input.value = onlyDigits(input.value).slice(0,1); if (input.value && idx < otpInputs.length - 1) otpInputs[idx+1].focus(); syncHidden(); });
      input?.addEventListener('keydown', (e) => { if (e.key === 'Backspace' && !input.value && idx > 0) otpInputs[idx-1].focus(); });
      input?.addEventListener('paste', (e) => { const t=(e.clipboardData||window.clipboardData).getData('text'); if(!t) return; e.preventDefault(); const d=onlyDigits(t).slice(0,6).split(''); otpInputs.forEach((i,k)=>{ i.value=d[k]||''; }); (otpInputs[d.length-1]||otpInputs[0]).focus(); syncHidden(); });
    });

    // Deshabilitar "Reenviar código" tras enviar
    function disableResend(form) {
      const btn = document.getElementById('resendBtn');
      const hint = document.getElementById('resendHint');
      if (!btn) return;
      btn.disabled = true;
      let seconds = 60;
      const tick = () => {
        if (seconds <= 0) { btn.disabled = false; hint.textContent = ''; return; }
        hint.textContent = `Podrás reenviar en ${seconds}s`;
        seconds -= 1;
        setTimeout(tick, 1000);
      };
      tick();
    }
  </script>
</body>
</html>
