<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Acceso Seguro | NextGen</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">

  <style>
    :root {
      /* --- PALETA DE LUJO --- */
      --emerald-dark: #022c22;
      --emerald-main: #059669;
      --emerald-light: #d1fae5;
      --gold-main: #d97706; /* Dorado rico */
      --gold-light: #fcd34d;
      --gold-glow: rgba(217, 119, 6, 0.25);
      
      --bg-body: #f8fafc;
      --bg-surface: #ffffff;
      --text-main: #0f172a;
      --text-muted: #64748b;
      --border-color: #e2e8f0;
      
      /* Sombras suaves */
      --shadow-lg: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
      --shadow-input: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
    }

    body {
      font-family: 'Plus Jakarta Sans', sans-serif;
      background-color: var(--bg-body);
      color: var(--text-main);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0;
    }

    /* --- LAYOUT PRINCIPAL --- */
    .auth-wrapper {
      width: 100%;
      max-width: 1100px;
      min-height: 650px;
      background: var(--bg-surface);
      border-radius: 24px;
      box-shadow: var(--shadow-lg);
      display: flex;
      overflow: hidden;
      margin: 20px;
      position: relative;
    }

    /* COLUMNA IZQUIERDA (VISUAL) */
    .auth-visual {
      flex: 1;
      background: radial-gradient(circle at top right, #047857, #064e3b);
      position: relative;
      display: none; /* Oculto en móvil */
      flex-direction: column;
      justify-content: space-between;
      padding: 3rem;
      color: white;
      overflow: hidden;
    }
    
    /* Patrón de fondo abstracto */
    .auth-visual::before {
      content: '';
      position: absolute;
      top: 0; left: 0; width: 100%; height: 100%;
      background-image: 
        radial-gradient(circle at 10% 10%, rgba(252, 211, 77, 0.1) 0%, transparent 20%),
        radial-gradient(circle at 90% 90%, rgba(252, 211, 77, 0.15) 0%, transparent 30%);
      pointer-events: none;
    }
    
    .auth-visual .glass-badge {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      padding: 0.5rem 1rem;
      border-radius: 50px;
      font-size: 0.85rem;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      width: fit-content;
    }

    /* COLUMNA DERECHA (FORMULARIO) */
    .auth-form-container {
      flex: 1;
      padding: 3rem;
      display: flex;
      flex-direction: column;
      justify-content: center;
      position: relative;
    }

    /* Barra de progreso */
    .progress-container {
      position: absolute;
      top: 0; left: 0; width: 100%;
      height: 4px;
      background: #f1f5f9;
    }
    .progress-bar-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--emerald-main), var(--gold-main));
      transition: width 0.5s ease-in-out;
      box-shadow: 0 0 10px var(--gold-glow);
    }

    /* Tipografía */
    h1 { font-weight: 800; font-size: 1.75rem; color: var(--emerald-dark); margin-bottom: 0.5rem; }
    .subtitle { color: var(--text-muted); font-size: 0.95rem; margin-bottom: 2rem; }

    /* Inputs Estilizados */
    .form-group { margin-bottom: 1.25rem; }
    .form-label { font-weight: 600; font-size: 0.85rem; color: var(--text-main); margin-bottom: 0.5rem; display: block; }
    
    .custom-input-group {
      position: relative;
      display: flex;
      align-items: center;
    }
    .custom-input-group i {
      position: absolute;
      left: 1rem;
      color: var(--text-muted);
      z-index: 10;
      transition: color 0.3s;
    }
    
    .form-control {
      padding: 0.8rem 1rem 0.8rem 2.8rem; /* espacio para el icono */
      border-radius: 12px;
      border: 2px solid var(--border-color);
      font-size: 0.95rem;
      transition: all 0.2s ease;
      background-color: #fcfcfc;
    }
    
    /* Estados del input */
    .form-control:focus {
      background-color: #fff;
      border-color: var(--emerald-main);
      box-shadow: 0 0 0 4px rgba(5, 150, 105, 0.1);
    }
    .form-control:focus + i, .custom-input-group:focus-within i {
      color: var(--emerald-main);
    }

    /* Botones */
    .btn-main {
      width: 100%;
      background: linear-gradient(135deg, var(--emerald-main), #047857);
      color: white;
      border: none;
      padding: 0.9rem;
      border-radius: 12px;
      font-weight: 700;
      font-size: 1rem;
      letter-spacing: 0.5px;
      transition: all 0.3s;
      box-shadow: 0 4px 6px -1px rgba(5, 150, 105, 0.2);
    }
    .btn-main:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 15px -3px rgba(5, 150, 105, 0.3);
      filter: brightness(1.1);
      color: white;
    }

    .btn-magic {
      width: 100%;
      background: white;
      color: var(--gold-main);
      border: 2px solid #fde68a;
      padding: 0.8rem;
      border-radius: 12px;
      font-weight: 700;
      font-size: 0.9rem;
      transition: all 0.3s;
      display: flex; align-items: center; justify-content: center; gap: 8px;
    }
    .btn-magic:hover {
      background: #fffbeb;
      border-color: var(--gold-main);
    }

    /* OTP Inputs */
    .otp-grid { display: grid; grid-template-columns: repeat(6, 1fr); gap: 8px; margin-bottom: 1rem; }
    .otp-input {
      width: 100%;
      height: 50px;
      text-align: center;
      font-size: 1.25rem;
      font-weight: 700;
      border: 2px solid var(--border-color);
      border-radius: 10px;
      background: white;
      transition: all 0.2s;
    }
    .otp-input:focus {
      border-color: var(--gold-main);
      box-shadow: 0 0 0 3px rgba(217, 119, 6, 0.15);
      outline: none;
      transform: scale(1.05);
    }

    /* Animaciones */
    .fade-in-up { animation: fadeInUp 0.5s ease-out forwards; opacity: 0; transform: translateY(10px); }
    @keyframes fadeInUp { to { opacity: 1; transform: translateY(0); } }

    /* Media Queries */
    @media (min-width: 992px) {
      .auth-visual { display: flex; } /* Mostrar lado izquierdo en PC */
    }
    @media (max-width: 576px) {
      .auth-wrapper { margin: 0; border-radius: 0; min-height: 100vh; box-shadow: none; }
      .auth-form-container { padding: 2rem 1.5rem; }
      .otp-grid { gap: 4px; }
    }
  </style>
</head>
<body>

  <div class="auth-wrapper">
    <div class="progress-container">
      <div class="progress-bar-fill" style="width:
        {% if step == 'email' %}25%
        {% elif step == 'password' %}50%
        {% elif step == 'code' %}75%
        {% elif step == 'register' %}90%
        {% else %}0%{% endif %}">
      </div>
    </div>

    <div class="auth-visual">
      <div>
        <div class="glass-badge mb-4">
          <i class="bi bi-shield-check text-warning"></i> Sistema Seguro
        </div>
        <h2 class="display-6 fw-bold mb-3">Bienvenido a <br><span style="color: #fbbf24;">NextGen</span></h2>
        <p class="opacity-75">La plataforma diseñada para potenciar tu experiencia digital con seguridad de grado bancario.</p>
      </div>
      
      <div class="d-flex align-items-center gap-3 opacity-50 small">
        <span><i class="bi bi-check-circle-fill text-warning me-1"></i> Encriptación SSL</span>
        <span><i class="bi bi-check-circle-fill text-warning me-1"></i> Soporte 24/7</span>
      </div>
    </div>

    <div class="auth-form-container">
      
      {% if messages %}
        <div class="mb-4 fade-in-up">
          {% for msg in messages %}
            <div class="alert alert-{{ msg.tags }} border-0 shadow-sm d-flex align-items-center gap-2" role="alert" style="font-size: 0.9rem;">
              <i class="bi bi-info-circle-fill"></i> {{ msg }}
            </div>
          {% endfor %}
        </div>
      {% endif %}

      {% if step == 'email' %}
        <div class="fade-in-up">
          <div class="mb-4">
            <div class="d-inline-block p-3 rounded-circle bg-light text-success mb-3">
              <i class="bi bi-person-fill fs-3"></i>
            </div>
            <h1>¡Hola de nuevo!</h1>
            <p class="subtitle">Ingresa tu correo para comenzar. Si no tienes cuenta, la crearemos juntos.</p>
          </div>

          <form method="post" id="emailForm" novalidate>
            {% csrf_token %}
            <input type="hidden" name="action" value="submit_email">
            <input type="hidden" name="next" value="{{ next|default:'' }}">

            <div class="form-group">
              <label class="form-label">Correo electrónico</label>
              <div class="custom-input-group">
                <i class="bi bi-envelope"></i>
                {{ email_form.email }}
              </div>
              <div id="emailInvalid" class="text-danger small mt-2 fw-semibold" style="display:none">
                <i class="bi bi-exclamation-circle me-1"></i> Por favor, ingresa un correo válido.
              </div>
            </div>

            <button class="btn-main mb-3" type="submit" id="emailSubmit">
              Continuar <i class="bi bi-arrow-right-short"></i>
            </button>

            <a href="{% url 'magic_start' %}" class="btn-magic text-decoration-none" id="passlessBtn">
              <i class="bi bi-stars"></i> Ingreso Mágico sin contraseña
            </a>
          </form>
        </div>
      {% endif %}

      {% if step == 'password' %}
        <div class="fade-in-up">
          <div class="mb-4">
            <a href="#" onclick="history.back()" class="text-decoration-none text-muted small mb-3 d-inline-block"><i class="bi bi-arrow-left"></i> Volver</a>
            <h1>Ingresa tu clave</h1>
            <p class="subtitle">Hola <strong>{{ email }}</strong>, introduce tu contraseña para acceder.</p>
          </div>

          <form method="post" novalidate>
            {% csrf_token %}
            <input type="hidden" name="action" value="submit_password">
            <input type="hidden" name="next" value="{{ next|default:'' }}">

            <div class="form-group">
              <label class="form-label">Contraseña</label>
              <div class="custom-input-group">
                <i class="bi bi-key"></i>
                {{ password_form.password }}
                <button class="btn border-0 position-absolute end-0 text-muted" type="button" id="togglePwd" style="z-index: 20;">
                  <i class="bi bi-eye"></i>
                </button>
              </div>
              <div class="text-danger small mt-1">{{ password_form.password.errors }}</div>
            </div>
            
            <div class="d-flex justify-content-end mb-4">
              <a href="#" class="small text-decoration-none fw-semibold" style="color: var(--gold-main);">¿Olvidaste tu contraseña?</a>
            </div>

            <button class="btn-main" type="submit">Iniciar Sesión</button>
          </form>
        </div>
      {% endif %}

      {% if step == 'code' %}
        <div class="fade-in-up">
          <div class="text-center mb-4">
            <div class="d-inline-block p-3 rounded-circle bg-light text-warning mb-3">
              <i class="bi bi-shield-lock-fill fs-3"></i>
            </div>
            <h1>Verificación</h1>
            <p class="subtitle">Hemos enviado un código de 6 dígitos a <br><strong>{{ email }}</strong></p>
          </div>

          <form id="restartEmail" method="post" class="text-center mb-4">
            {% csrf_token %}
            <input type="hidden" name="action" value="submit_email">
            <button class="btn btn-sm btn-link text-muted text-decoration-none" type="submit">
              ¿No es tu correo? Cambiar
            </button>
          </form>

          <form method="post" id="codeForm" novalidate>
            {% csrf_token %}
            <input type="hidden" name="action" value="submit_code">
            <input type="hidden" name="next" value="{{ next|default:'' }}">

            <div class="visually-hidden">{{ code_form.code }}</div>

            <div class="otp-grid">
              <input type="tel" maxlength="1" class="otp-input" id="otp1">
              <input type="tel" maxlength="1" class="otp-input" id="otp2">
              <input type="tel" maxlength="1" class="otp-input" id="otp3">
              <input type="tel" maxlength="1" class="otp-input" id="otp4">
              <input type="tel" maxlength="1" class="otp-input" id="otp5">
              <input type="tel" maxlength="1" class="otp-input" id="otp6">
            </div>
            
            <div class="text-danger small text-center fw-bold mb-3" id="codeErrors">{{ code_form.code.errors }}</div>

            <button class="btn-main mt-2" type="submit">Verificar</button>
          </form>

          <div class="mt-4 text-center">
            <form method="post" onsubmit="disableResend(this)" novalidate>
              {% csrf_token %}
              <input type="hidden" name="action" value="submit_email">
              <input type="hidden" name="email" value="{{ email }}">
              <button id="resendBtn" class="btn btn-link text-decoration-none fw-bold" style="color: var(--emerald-main);" type="submit">
                Reenviar código
              </button>
              <div class="small text-muted" id="resendHint"></div>
            </form>
          </div>
        </div>
      {% endif %}

      {% if step == 'register' %}
        <div class="fade-in-up">
          <div class="mb-4">
            <h1>Crear Cuenta</h1>
            <p class="subtitle">Completa tus datos para finalizar el registro con <strong>{{ email }}</strong>.</p>
          </div>

          <form method="post" novalidate>
            {% csrf_token %}
            <input type="hidden" name="action" value="submit_register">
            <input type="hidden" name="next" value="{{ next|default:'' }}">

            <div class="row g-3">
              <div class="col-6">
                <div class="form-group">
                  <label class="form-label">Nombre</label>
                  <div class="custom-input-group">
                    <i class="bi bi-person"></i>
                    {{ register_form.first_name }}
                  </div>
                  <div class="text-danger small mt-1">{{ register_form.first_name.errors }}</div>
                </div>
              </div>
              <div class="col-6">
                <div class="form-group">
                  <label class="form-label">Apellido</label>
                  <div class="custom-input-group">
                    <i class="bi bi-person-badge"></i>
                    {{ register_form.last_name }}
                  </div>
                  <div class="text-danger small mt-1">{{ register_form.last_name.errors }}</div>
                </div>
              </div>
            </div>

            <div class="form-group">
              <label class="form-label">Contraseña</label>
              <div class="custom-input-group">
                <i class="bi bi-lock"></i>
                {{ register_form.password1 }}
                <button class="btn border-0 position-absolute end-0 text-muted" type="button" id="togglePwd1" style="z-index: 20;">
                  <i class="bi bi-eye"></i>
                </button>
              </div>
              <div class="text-danger small mt-1">{{ register_form.password1.errors }}</div>
            </div>

            <div class="form-group">
              <label class="form-label">Repetir Contraseña</label>
              <div class="custom-input-group">
                <i class="bi bi-lock-fill"></i>
                {{ register_form.password2 }}
              </div>
              <div class="text-danger small mt-1">{{ register_form.password2.errors }}</div>
            </div>

            <button class="btn-main mt-3" type="submit">Finalizar Registro</button>
          </form>
        </div>
      {% endif %}
      
      <div class="mt-auto pt-5 text-center">
        <p class="text-muted small mb-0">
          Protegido por reCAPTCHA y sujeto a la <a href="#" class="text-decoration-none fw-bold" style="color: var(--emerald-main);">Política de Privacidad</a>.
        </p>
      </div>

    </div>
  </div>

  <script>
    // 1. Añadir clase 'form-control' a los inputs de Django si no la tienen
    document.querySelectorAll('input').forEach(input => {
      if(!input.classList.contains('form-control') && !input.classList.contains('otp-input') && input.type !== 'hidden') {
        input.classList.add('form-control');
      }
    });

    // 2. Toggle Password
    const setupToggle = (btnId, inputId) => {
      const btn = document.getElementById(btnId);
      // Buscamos el input dentro del mismo grupo o por ID si Django genera el ID esperado
      // Como Django a veces cambia IDs, buscamos el input hermano previo
      if(btn) {
        btn.addEventListener('click', () => {
          const input = btn.previousElementSibling;
          if(input) {
            const isPwd = input.getAttribute('type') === 'password';
            input.setAttribute('type', isPwd ? 'text' : 'password');
            btn.querySelector('i').className = isPwd ? 'bi bi-eye-slash' : 'bi bi-eye';
          }
        });
      }
    };
    setupToggle('togglePwd', 'dummy'); // El input es hermano previo
    setupToggle('togglePwd1', 'dummy');

    // 3. Validación de Email Visual
    const emailInput = document.getElementById('id_email');
    const emailInvalid = document.getElementById('emailInvalid');
    
    if(emailInput) {
      const validateEmail = () => {
        const val = emailInput.value;
        const isValid = /^[^\s@]+@[^\s@]+\.[^\s@]{2,}$/.test(val);
        if(val.length > 0 && !isValid) {
          emailInput.classList.add('border-danger');
          emailInvalid.style.display = 'block';
        } else {
          emailInput.classList.remove('border-danger');
          emailInvalid.style.display = 'none';
        }
      };
      emailInput.addEventListener('blur', validateEmail);
      emailInput.addEventListener('input', () => {
        // Limpiar error al escribir
        emailInput.classList.remove('border-danger');
        emailInvalid.style.display = 'none';
      });
    }

    // 4. OTP Logic (Pegar y Auto-focus)
    const otpInputs = Array.from(document.querySelectorAll('.otp-input'));
    const hiddenCode = document.querySelector('input[name="code"]'); // El input de Django

    if(otpInputs.length > 0) {
      const syncHidden = () => {
        if(hiddenCode) {
          hiddenCode.value = otpInputs.map(i => i.value).join('');
        }
      };

      otpInputs.forEach((input, index) => {
        // Al escribir número
        input.addEventListener('input', (e) => {
          // Solo números
          input.value = input.value.replace(/[^0-9]/g, '');
          
          if(input.value.length === 1) {
            // Saltar al siguiente
            if(index < 5) otpInputs[index + 1].focus();
          }
          syncHidden();
        });

        // Borrar (Backspace)
        input.addEventListener('keydown', (e) => {
          if(e.key === 'Backspace' && !input.value && index > 0) {
            otpInputs[index - 1].focus();
          }
        });

        // Pegar código completo
        input.addEventListener('paste', (e) => {
          e.preventDefault();
          const data = e.clipboardData.getData('text').replace(/[^0-9]/g, '').slice(0, 6);
          data.split('').forEach((char, i) => {
            if(otpInputs[i]) otpInputs[i].value = char;
          });
          syncHidden();
          // Enfocar el último o el siguiente vacío
          const nextEmpty = otpInputs.find(i => !i.value);
          if(nextEmpty) nextEmpty.focus();
          else otpInputs[5].focus();
        });
      });
    }

    // 5. Timer de Reenvío
    function disableResend(form) {
      const btn = document.getElementById('resendBtn');
      const hint = document.getElementById('resendHint');
      if(!btn) return;
      
      btn.style.pointerEvents = 'none';
      btn.style.opacity = '0.5';
      let count = 60;
      
      const timer = setInterval(() => {
        count--;
        hint.textContent = `Espera ${count}s para reenviar`;
        if(count === 0) {
          clearInterval(timer);
          btn.style.pointerEvents = 'auto';
          btn.style.opacity = '1';
          hint.textContent = '';
        }
      }, 1000);
    }
  </script>
</body>
</html>